<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.2.xsd">

	<changeSet author="EdwardLegaspi" id="#1087_20150922">
		<createTable tableName="meveo_filter_parameter">
			<column name="id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="version" type="INT4" />
			<column name="disabled" type="BOOL">
				<constraints nullable="false" />
			</column>
			<column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="TIMESTAMP WITHOUT TIME ZONE" />
			<column name="provider_id" type="BIGINT" />
			<column name="creator_id" type="BIGINT" />
			<column name="updater_id" type="BIGINT" />
			<column name="code" type="VARCHAR(60)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="VARCHAR(100)" />
			<column name="default_value" type="VARCHAR(50)" />
			<column name="value_required" type="BOOL" />
			<column name="field_type" type="VARCHAR(255)" />
			<column name="entity_clazz" type="VARCHAR(255)" />
			<column name="filter_id" type="BIGINT" />
		</createTable>

		<addPrimaryKey columnNames="id" constraintName="meveo_filter_parameter_pkey"
			tableName="meveo_filter_parameter" />

		<addForeignKeyConstraint baseColumnNames="provider_id"
			baseTableName="meveo_filter_parameter" constraintName="fk_meveo_filter_parameter_crm_provider"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
		
		<addForeignKeyConstraint baseColumnNames="creator_id"
			baseTableName="meveo_filter_parameter" constraintName="fk_creator_meveo_filter_parameter_adm_user"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
		
		<addForeignKeyConstraint baseColumnNames="updater_id"
			baseTableName="meveo_filter_parameter" constraintName="fk_updater_meveo_filter_parameter_adm_user"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
		
		<addForeignKeyConstraint baseColumnNames="filter_id"
			baseTableName="meveo_filter_parameter" constraintName="fk_meveo_filter_parameter_meveo_filter"
			deferrable="false" initiallyDeferred="false" onDelete="CASCADE"
			onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="meveo_filter" />

		<createTable tableName="meveo_filter_parameter_list_val">
			<column name="filterparameter_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="listvalues" type="VARCHAR(255)" />
			<column name="listvalues_key" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createSequence sequenceName="meveo_filter_parameter_seq" />
	</changeSet>

	<changeSet author="anasseh" id="20150928_text">
     	<modifyDataType columnName="string_value" newDataType="text"   tableName="CRM_CUSTOM_FIELD_INST"/>
     </changeSet>
    
    <changeSet author="AndriusKarpavicius" id="#1094_20150929">
		<addColumn tableName="CRM_CUSTOM_FIELD_INST">
			<column name="seller_id" type="BIGINT" />
		</addColumn>    
    
    	<addForeignKeyConstraint constraintName="fk_seller_id_crm_custom_field_inst"
			referencedTableName="CRM_SELLER" baseColumnNames="seller_id"
			baseTableName="CRM_CUSTOM_FIELD_INST" referencedColumnNames="id" />
    </changeSet>

    <changeSet author="AndriusKarpavicius" id="#1123_20151006">
        <dropColumn tableName="MEVEO_JOB_INSTANCE" columnName="user_id"/>
    </changeSet>
	 <changeSet author="anasseh" id="#1117_20151005">
		    <addColumn tableName="BILLING_CYCLE">
	            <column name="INVOICING_THRESHOLD" type="numeric(23, 12)" />
	        </addColumn>	
	</changeSet>       
    <changeSet author="anasseh" id="20151009_1149">
        <modifyDataType columnName="SELECTED_BILLING_ACCOUNTS" newDataType="text"   tableName="BILLING_BILLING_RUN"/>
     </changeSet>
   	<changeSet author="anasseh" id="20151013_1165">
     	<modifyDataType columnName="MESSAGE" newDataType="text"   tableName="MEVEO_SCRIPT_INSTANCE_ERROR"/>
     </changeSet>

    <changeSet id="#1150_20151013" author="Mbarek">
	<addColumn tableName="BILLING_INVOICE_CONFIGURATION">
	<column name="display_provider" type="BOOL" defaultValueBoolean="false"></column>
	</addColumn>
	</changeSet>
	
	  <changeSet id="1201_20151102" author="Mbarek">
		<sql>ALTER TABLE crm_custom_field_tmpl DROP CONSTRAINT IF EXISTS uk_odjxv76fr14lrm19mt961b04p;</sql>
	</changeSet>

    <changeSet id="#1101_20151021" author="AndriusKarpavicius">
        <createSequence sequenceName="CRM_CUSTOM_FIELD_FIELDS_SEQ"/>
        <createTable tableName="CRM_CUSTOM_FIELD_FIELDS">
            <column name="id" type="BIGINT">
                <constraints nullable="false"  />
            </column>
            <column name="version" type="INT4" />        
            <column name="provider_id" type="BIGINT" />
            <column name="UUID" type="VARCHAR(60)" >
                <constraints nullable="false"/>
            </column> 
        </createTable>
        
        <addColumn tableName="CRM_CUSTOM_FIELD_INST">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        
        <addPrimaryKey columnNames="id" constraintName="crm_custom_field_fields_pkey"
            tableName="CRM_CUSTOM_FIELD_FIELDS" />
            
        <addForeignKeyConstraint constraintName="fk_crm_custom_field_inst_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="CRM_CUSTOM_FIELD_INST" referencedColumnNames="id" />
        
        <addColumn tableName="MEDINA_ACCESS">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>        
        <addColumn tableName="CRM_PROVIDER">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="ACCOUNT_ENTITY">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="CAT_CHARGE_TEMPLATE">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="MEVEO_JOB_INSTANCE">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="CAT_OFFER_TEMPLATE">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="CRM_SELLER">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="CAT_SERVICE_TEMPLATE">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="BILLING_SUBSCRIPTION">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        
        <addForeignKeyConstraint constraintName="fk_medina_access_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="MEDINA_ACCESS" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_crm_provider_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="CRM_PROVIDER" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_account_entity_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="ACCOUNT_ENTITY" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_cat_charge_template_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="CAT_CHARGE_TEMPLATE" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_meveo_job_instance_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="MEVEO_JOB_INSTANCE" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_cat_offer_template_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="CAT_OFFER_TEMPLATE" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_crm_seller_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="CRM_SELLER" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_cat_service_template_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="CAT_SERVICE_TEMPLATE" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_billing_subscription_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="BILLING_SUBSCRIPTION" referencedColumnNames="id" />
        
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'provider_'||cfi_ent_id, cfi_ent_id from (select distinct provider_id as cfi_ent_id from crm_custom_field_inst where provider_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='provider_'||crm_custom_field_inst.provider_id) where provider_id is not null;
            update crm_provider set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='provider_'||crm_provider.id);
        </sql>        
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'access_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct medina_access.id as cfi_ent_id, medina_access.provider_id as cfi_ent_provider_id from crm_custom_field_inst join medina_access on crm_custom_field_inst.access_id =medina_access.id and crm_custom_field_inst.access_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='access_'||crm_custom_field_inst.access_id) where access_id is not null;
            update medina_access set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='access_'||medina_access.id);
        </sql>
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'charge_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct CAT_CHARGE_TEMPLATE.id as cfi_ent_id, CAT_CHARGE_TEMPLATE.provider_id as cfi_ent_provider_id from crm_custom_field_inst join CAT_CHARGE_TEMPLATE on crm_custom_field_inst.charge_template_id =CAT_CHARGE_TEMPLATE.id and crm_custom_field_inst.charge_template_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='charge_'||crm_custom_field_inst.charge_template_id) where charge_template_id is not null;
            update CAT_CHARGE_TEMPLATE set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='charge_'||CAT_CHARGE_TEMPLATE.id);
        </sql>
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'offer_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct CAT_OFFER_TEMPLATE.id as cfi_ent_id, CAT_OFFER_TEMPLATE.provider_id as cfi_ent_provider_id from crm_custom_field_inst join CAT_OFFER_TEMPLATE on crm_custom_field_inst.offer_template_id =CAT_OFFER_TEMPLATE.id and crm_custom_field_inst.offer_template_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='offer_'||crm_custom_field_inst.offer_template_id) where offer_template_id is not null;
            update CAT_OFFER_TEMPLATE set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='offer_'||CAT_OFFER_TEMPLATE.id);
        </sql>
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'service_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct CAT_SERVICE_TEMPLATE.id as cfi_ent_id, CAT_SERVICE_TEMPLATE.provider_id as cfi_ent_provider_id from crm_custom_field_inst join CAT_SERVICE_TEMPLATE on crm_custom_field_inst.service_template_id =CAT_SERVICE_TEMPLATE.id and crm_custom_field_inst.service_template_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='service_'||crm_custom_field_inst.service_template_id) where service_template_id is not null;
            update CAT_SERVICE_TEMPLATE set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='service_'||CAT_SERVICE_TEMPLATE.id);
        </sql>
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'subs_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct BILLING_SUBSCRIPTION.id as cfi_ent_id, BILLING_SUBSCRIPTION.provider_id as cfi_ent_provider_id from crm_custom_field_inst join BILLING_SUBSCRIPTION on crm_custom_field_inst.subscription_id =BILLING_SUBSCRIPTION.id and crm_custom_field_inst.subscription_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='subs_'||crm_custom_field_inst.subscription_id) where subscription_id is not null;
            update BILLING_SUBSCRIPTION set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='subs_'||BILLING_SUBSCRIPTION.id);
        </sql>
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'job_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct MEVEO_JOB_INSTANCE.id as cfi_ent_id, MEVEO_JOB_INSTANCE.provider_id as cfi_ent_provider_id from crm_custom_field_inst join MEVEO_JOB_INSTANCE on crm_custom_field_inst.job_instance_id =MEVEO_JOB_INSTANCE.id and crm_custom_field_inst.job_instance_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='job_'||crm_custom_field_inst.job_instance_id) where job_instance_id is not null;
            update MEVEO_JOB_INSTANCE set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='job_'||MEVEO_JOB_INSTANCE.id);
        </sql>
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'seller_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct CRM_SELLER.id as cfi_ent_id, CRM_SELLER.provider_id as cfi_ent_provider_id from crm_custom_field_inst join CRM_SELLER on crm_custom_field_inst.seller_id =CRM_SELLER.id and crm_custom_field_inst.seller_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='seller_'||crm_custom_field_inst.seller_id) where seller_id is not null;
            update CRM_SELLER set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='seller_'||CRM_SELLER.id);        
        </sql>
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'account_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct ACCOUNT_ENTITY.id as cfi_ent_id, ACCOUNT_ENTITY.provider_id as cfi_ent_provider_id from crm_custom_field_inst join ACCOUNT_ENTITY on crm_custom_field_inst.account_id =ACCOUNT_ENTITY.id and crm_custom_field_inst.account_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='account_'||crm_custom_field_inst.account_id) where account_id is not null;
            update ACCOUNT_ENTITY set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='account_'||ACCOUNT_ENTITY.id);
        </sql>
        
        <addNotNullConstraint tableName="CRM_CUSTOM_FIELD_INST" columnName="CFF_ID"/>
        
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="provider_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="access_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="charge_template_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="offer_template_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="service_template_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="subscription_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="job_instance_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="seller_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="account_id"/>
                
        <addColumn tableName="CRM_CUSTOM_FIELD_TMPL">
            <column name="APPLIES_TO" type="VARCHAR(100)"/>
        </addColumn>
        
        <sql>
            update CRM_CUSTOM_FIELD_TMPL set applies_to = account_type where account_type&lt;&gt; 'TIMER';
            update CRM_CUSTOM_FIELD_TMPL set applies_to = 'JOB_'|| SUBSTR(code, 0, strpos(code, '_')) where account_type= 'TIMER';
            update CRM_CUSTOM_FIELD_TMPL set code = 'nbRuns' where right(code,7)='_nbRuns' and account_type= 'TIMER';
            update CRM_CUSTOM_FIELD_TMPL set code = 'waitingMillis' where right(code,14)='_waitingMillis' and account_type= 'TIMER';        
        </sql>
        
        <sql>
            update CRM_CUSTOM_FIELD_TMPL set storage_type='SINGLE' where storage_type is null;
        </sql>
        
        <addNotNullConstraint tableName="CRM_CUSTOM_FIELD_TMPL" columnName="APPLIES_TO"/>
        <addNotNullConstraint tableName="CRM_CUSTOM_FIELD_TMPL" columnName="field_type"/>
        <addNotNullConstraint tableName="CRM_CUSTOM_FIELD_TMPL" columnName="storage_type"/>
        
        <dropColumn tableName="CRM_CUSTOM_FIELD_TMPL" columnName="account_type"/>
        
    </changeSet> 
    
    <changeSet id="1201-20151102" author="Mbarek">
		<addUniqueConstraint columnNames="code,applies_to,provider_id" constraintName="uk_abfci88fr16lqf19cf961b08d" deferrable="false" disabled="false"
            initiallyDeferred="false" tableName="crm_custom_field_tmpl" />
	</changeSet>          

	<changeSet author="EdwardLegaspi" id="#1147_20151009">
		<addColumn tableName="crm_provider">
			<column name="credit_note_prefix" type="VARCHAR(255)" />
			<column name="current_credit_note_nb" type="BIGINT" />
		</addColumn>
		<addColumn tableName="crm_seller">
			<column name="credit_note_prefix" type="VARCHAR(255)" />
			<column name="current_credit_note_nb" type="BIGINT" />
		</addColumn>
	</changeSet>

	<changeSet id="#1138_20151009" author="EdwardLegaspi">
		<addColumn tableName="crm_provider">
			<column name="credit_note_sequence_size" type="INT4" />
		</addColumn>
		<addColumn tableName="crm_seller">
			<column name="credit_note_sequence_size" type="INT4" />
		</addColumn>

		<sql>UPDATE crm_provider SET credit_note_sequence_size=9;</sql>
	</changeSet>

	<changeSet id="#1167_20151015" author="EdwardLegaspi">
		<addColumn tableName="crm_provider">
			<column name="invoice_adjustment_prefix" type="VARCHAR(255)" />
			<column name="current_invoice_adjustment_nb" type="BIGINT" />
			<column name="invoice_adjustment_sequence_size" type="INT4" />
		</addColumn>
		<addColumn tableName="crm_seller">
			<column name="invoice_adjustment_prefix" type="VARCHAR(255)" />
			<column name="current_invoice_adjustment_nb" type="BIGINT" />
			<column name="invoice_adjustment_sequence_size" type="INT4" />
		</addColumn>

		<addColumn tableName="billing_invoice">
			<column name="detailed_invoice" type="boolean" defaultValue="true" />
			<column name="invoice_id" type="BIGINT" />
		</addColumn>

		<addForeignKeyConstraint constraintName="fk_billing_invoice_adjusted_invoice"
			referencedTableName="billing_invoice" baseColumnNames="invoice_id"
			baseTableName="billing_invoice" referencedColumnNames="id" />

		<sql>UPDATE billing_invoice SET invoice_type='COMMERCIAL'</sql>
	</changeSet>

	<changeSet id="#1170_20151020" author="EdwardLegaspi">
		<addColumn tableName="billing_invoice_configuration">
			<column name="display_detail" type="BOOL" defaultValueBoolean="true"></column>
		</addColumn>
	</changeSet>

	<changeSet id="#1184_20151022" author="EdwardLegaspi">
		<addColumn tableName="billing_rated_transaction">
			<column name="adjusted_rated_tx" type="BIGINT" />
		</addColumn>

		<addForeignKeyConstraint
			constraintName="fk_billing_rated_transaction_rated_transaction"
			referencedTableName="billing_rated_transaction" baseColumnNames="adjusted_rated_tx"
			baseTableName="billing_rated_transaction" referencedColumnNames="id" />		
	</changeSet>
	
	<changeSet id="#1134-20151026" author="Mbarek">
		<addColumn tableName="crm_provider"> 
			<column name="INVOICE_SEQUENCE_SIZE" type="INT4" defaultValue="9" />
		</addColumn>
		<addColumn tableName="crm_seller"> 
			<column name="INVOICE_SEQUENCE_SIZE" type="INT4" defaultValue="9" />
		</addColumn>
	</changeSet>

    <changeSet id="#1101_20151022" author="AndriusKarpavicius">
    
        <addForeignKeyConstraint baseColumnNames="provider_id"
            baseTableName="crm_custom_field_fields" constraintName="fk_crm_custom_field_fields_crm_provider"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
            
    </changeSet>
    
    <changeSet id="#1102_20151023" author="AndriusKarpavicius">
        <createSequence sequenceName="CUST_CET_SEQ"/>
        
        <createTable tableName="CUST_CET">
            <column name="id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="version" type="INT4" />
            <column name="disabled" type="BOOL">
                <constraints nullable="false" />
            </column>
            <column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="TIMESTAMP WITHOUT TIME ZONE" />
            <column name="description" type="VARCHAR(100)" />
            <column name="code" type="VARCHAR(50)" />
            <column name="provider_id" type="BIGINT" />
            <column name="creator_id" type="BIGINT" />
            <column name="updater_id" type="BIGINT" />
        </createTable>
    
        <addPrimaryKey columnNames="id" constraintName="cust_cet_pkey"
            tableName="cust_cet" />

        <addForeignKeyConstraint baseColumnNames="provider_id"
            baseTableName="cust_cet" constraintName="fk_cust_cet_crm_provider"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
        
        <addForeignKeyConstraint baseColumnNames="creator_id"
            baseTableName="cust_cet" constraintName="fk_creator_cust_cet_adm_user"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
        
        <addForeignKeyConstraint baseColumnNames="updater_id"
            baseTableName="cust_cet" constraintName="fk_updater_cust_cet_adm_user"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />        
    
    </changeSet>
    
    <changeSet id="#1102_20151030" author="AndriusKarpavicius">
        <addColumn tableName="CUST_CET">
            <column name="ACCESS_PERMISSION" type="VARCHAR(100)"/>        
        </addColumn>
        
        <addColumn tableName="CRM_CUSTOM_FIELD_TMPL">
            <column name="GUI_POSITION" type="VARCHAR(100)"/>
        </addColumn>
    </changeSet>
    
     <changeSet id="2037_20151105" author="Mbarek">
     	<modifyDataType columnName="FILTER_PARAM_1" newDataType="varchar(255)"   tableName="CAT_USAGE_CHARGE_TEMPLATE"/>
     	<modifyDataType columnName="FILTER_PARAM_2" newDataType="varchar(255)"   tableName="CAT_USAGE_CHARGE_TEMPLATE"/>
     	<modifyDataType columnName="FILTER_PARAM_3" newDataType="varchar(255)"   tableName="CAT_USAGE_CHARGE_TEMPLATE"/>
     	<modifyDataType columnName="FILTER_PARAM_4" newDataType="varchar(255)"   tableName="CAT_USAGE_CHARGE_TEMPLATE"/>
     </changeSet>
     
     <changeSet author="1187_20151102" id="Mbarek">
		<createTable tableName="adm_script_notification">
			<column name="id" type="BIGINT">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addPrimaryKey columnNames="id"
			constraintName="adm_script_notification_pkey" tableName="adm_script_notification" />
		<addForeignKeyConstraint baseColumnNames="id"
			baseTableName="adm_script_notification" constraintName="fk_n1n2i3ht998wlegdshme8gyfd"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_notification" />

		<!--migration notifications -->
		<sql splitStatements="false">
			create or replace function scriptNotification() returns void as
			$body$
			declare
			cursorNotif cursor for
			select * from adm_notification where id not in(
			SELECT id FROM adm_notif_webhooks
			UNION
			SELECT id FROM adm_notif_email
			UNION
			SELECT id FROM adm_notif_job
			UNION
			SELECT id FROM adm_notif_history
			);
			notifRecord record;
			begin
			open cursorNotif;
			loop
			fetch cursorNotif into notifRecord;
			exit when not found;
			insert into adm_script_notification(id) values(notifRecord.id);
			end loop;
			close cursorNotif;
			end;
			$body$
			language plpgsql volatile;
			<!--execute function -->
			select scriptNotification();
		</sql>
	</changeSet>
    
    <changeSet id="#1102_20151105" author="AndriusKarpavicius">
        <createSequence sequenceName="CUST_CEI_SEQ"/>
        
        <createTable tableName="CUST_CEI">
            <column name="id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="version" type="INT4" />
            <column name="disabled" type="BOOL">
                <constraints nullable="false" />
            </column>
            <column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="TIMESTAMP WITHOUT TIME ZONE" />
            <column name="description" type="VARCHAR(100)" />
            <column name="code" type="VARCHAR(50)" />
            <column name="provider_id" type="BIGINT" />
            <column name="creator_id" type="BIGINT" />
            <column name="updater_id" type="BIGINT" />
            <column name="cet_code" type="VARCHAR(50)" />
            <column name="CFF_ID" type="BIGINT"/>
        </createTable>    
        
        <addPrimaryKey columnNames="id" constraintName="crm_cust_cei_pkey" tableName="CUST_CEI" />
                    
        <addUniqueConstraint columnNames="code,cet_code,provider_id" constraintName="uk_cust_cei" deferrable="false" disabled="false"
                    initiallyDeferred="false" tableName="CUST_CEI" />

        <addForeignKeyConstraint baseColumnNames="provider_id"
            baseTableName="CUST_CEI" constraintName="fk_cust_cei_crm_provider"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
            
        <addForeignKeyConstraint constraintName="fk_cust_cei_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="CUST_CEI" referencedColumnNames="id" />
            
     </changeSet>
     
	<changeSet id="#1102_20151107" author="AndriusKarpavicius">
        <addColumn tableName="CUST_CET">
            <column name="name" type="VARCHAR(100)"/>        
        </addColumn>
        
        <dropColumn tableName="CUST_CET" columnName="ACCESS_PERMISSION"/>
        <addColumn tableName="CUST_CET">
            <column name="permission_id" type="BIGINT"/>
        </addColumn>
        
        <addForeignKeyConstraint baseColumnNames="permission_id"
            baseTableName="CUST_CET" constraintName="fk_cust_cet_adm_permission"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_permission" />
    </changeSet>
    
      <changeSet author="TyshanShi" id="#1103_20151108">
		<createTable tableName="meveo_module">
		<column name="id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="version" type="INT4" />
			<column name="disabled" type="BOOL">
				<constraints nullable="false" />
			</column>
			<column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="TIMESTAMP WITHOUT TIME ZONE" />
			<column name="provider_id" type="BIGINT" />
			<column name="creator_id" type="BIGINT" />
			<column name="updater_id" type="BIGINT" />
			<column name="code" type="VARCHAR(60)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="VARCHAR(100)" />
			<column name="module_status" type="VARCHAR(10)" />
		</createTable>
		<addPrimaryKey columnNames="id" constraintName="meveo_module_pkey"
			tableName="meveo_module" />
		<addForeignKeyConstraint baseColumnNames="provider_id"
			baseTableName="meveo_module" constraintName="fk_meveo_module_crm_provider"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
		<addForeignKeyConstraint baseColumnNames="creator_id"
			baseTableName="meveo_module" constraintName="fk_creator_meveo_module_adm_user"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
		<addForeignKeyConstraint baseColumnNames="updater_id"
			baseTableName="meveo_module" constraintName="fk_updater_meveo_module_adm_user"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
		<createSequence sequenceName="meveo_module_seq" startValue="1"/>
	</changeSet>
	<changeSet author="TyshanShi" id="#1103_20151108_1">
		<createTable tableName="meveo_module_item">
			<column name="id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="version" type="INT4" />
			<column name="provider_id" type="BIGINT" />
			<column name="module_id" type="BIGINT" />
			<column name="item_type" type="VARCHAR(20)" />
			<column name="item_code" type="VARCHAR(100)" />
			<column name="item_id" type="BIGINT" />
			<column name="clazz_name" type="VARCHAR(255)" />
			<column name="entity_name" type="VARCHAR(255)" />
		</createTable>
		<addPrimaryKey columnNames="id" constraintName="meveo_module_item_pkey"
			tableName="meveo_module_item" />
		<addForeignKeyConstraint baseColumnNames="provider_id"
			baseTableName="meveo_module_item" constraintName="fk_meveo_module_item_crm_provider"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
		<addForeignKeyConstraint baseColumnNames="module_id"
			baseTableName="meveo_module_item" constraintName="fk_meveo_module_item_meveo_module"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_module" />
		<createSequence sequenceName="meveo_module_item_seq" startValue="1"/>
	</changeSet>
    <changeSet author="anasseh" id="#1221_20151109">
        <createSequence sequenceName="FTP_IMPORTED_FILE_SEQ" startValue="1" />
    </changeSet>
    
    <changeSet author="anasseh" id="#1221_20151109_1">
        <createTable tableName="FTP_IMPORTED_FILE">
            <column name="id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="version" type="INT4" />
            <column name="disabled" type="BOOL">
                <constraints nullable="false" />
            </column>
            <column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="TIMESTAMP WITHOUT TIME ZONE" />
            <column name="provider_id" type="BIGINT" />
            <column name="creator_id" type="BIGINT" />
            <column name="updater_id" type="BIGINT" />
			<column name="code" type="VARCHAR(60)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="VARCHAR(100)" />
            <column name="URI" type="VARCHAR(2000)">
                <constraints nullable="false" />
            </column>
            <column name="SIZE" type="BIGINT"/>            
            <column name="IMPORT_DATE" type="TIMESTAMP WITHOUT TIME ZONE"/>
            <column name="LAST_MODIFICATION" type="TIMESTAMP WITHOUT TIME ZONE"/>

        </createTable>
        <addPrimaryKey columnNames="id" constraintName="Ftp_Imported_File_pkey"
            tableName="FTP_IMPORTED_FILE" />
        <addForeignKeyConstraint baseColumnNames="provider_id"
            baseTableName="FTP_IMPORTED_FILE" constraintName="fk_Ftp_Imported_File_crm_provider"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
        <addForeignKeyConstraint baseColumnNames="creator_id"
            baseTableName="FTP_IMPORTED_FILE" constraintName="fk_creator_Ftp_Imported_File_adm_user"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />

        <addForeignKeyConstraint baseColumnNames="updater_id"
            baseTableName="FTP_IMPORTED_FILE" constraintName="fk_updater_Ftp_Imported_File_adm_user"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
    </changeSet>		
	<changeSet author="TyshanShi" id="#1103_20151113_1">
        <delete tableName="meveo_module_item"/>
		<dropColumn tableName="meveo_module" columnName="module_status"/>
		<dropColumn tableName="meveo_module_item" columnName="clazz_name"/>
		<dropColumn tableName="meveo_module_item" columnName="entity_name"/>
		<dropColumn tableName="meveo_module_item" columnName="item_id"/>
		<dropColumn tableName="meveo_module_item" columnName="item_type"/>
		<dropColumn tableName="meveo_module_item" columnName="item_code"/>
		<addColumn tableName="meveo_module_item">
			<column name="applies_to" type="VARCHAR(100)"/>
			<column name="item_type" type="VARCHAR(20)">
				<constraints nullable="false"/>
			</column>
			<column name="item_code" type="VARCHAR(60)">
				<constraints nullable="false"/>
			</column>
		</addColumn>
	</changeSet>
    <changeSet id="#1102_20151117" author="AndriusKarpavicius">
        <dropColumn tableName="CUST_CET" columnName="permission_id"/>        
    </changeSet>
    <changeSet id="#1270_20151117" author="AndriusKarpavicius">
        <createTable tableName="adm_role_role">
            <column name="role_id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="child_role_id" type="BIGINT">
                <constraints nullable="false" />
            </column>
        </createTable>
        <sql>insert into adm_role (id, version, role_name, role_description, provider_id) (select nextval('adm_role_seq'), 0, 'ModifyAllCET', 'Modify all custom entities', crm_provider.id from crm_provider) </sql>
        <sql>insert into adm_role (id, version, role_name, role_description, provider_id) (select nextval('adm_role_seq'), 0, 'ReadAllCET', 'Read all custom entities', crm_provider.id from crm_provider) </sql>    
        <sql>insert into adm_role_role (role_id, child_role_id) (select role_p.id, role_c.id from adm_role role_p join adm_role role_c on role_p.provider_id=role_c.provider_id and role_p.role_name='administrateur' and role_c.role_name='ModifyAllCET')</sql>
        <sql>insert into adm_role_role (role_id, child_role_id) (select role_p.id, role_c.id from adm_role role_p join adm_role role_c on role_p.provider_id=role_c.provider_id and role_p.role_name='ModifyAllCET' and role_c.role_name='ReadAllCET')</sql>
    </changeSet>    
	<changeSet author="TyshanShi" id="#1103_20151119">
		<addColumn tableName="meveo_module">
			<column name="module_license" type="VARCHAR(20)">
				<constraints nullable="false"/>
			</column>
		</addColumn>
	</changeSet>
</databaseChangeLog>
