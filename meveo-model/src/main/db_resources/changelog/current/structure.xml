<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.2.xsd">

	<changeSet id="#1803_20160628" author="TonyAlejandro">
        <createTable tableName="ADM_SECURED_ENTITY">
   			<column name="user_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="code" type="VARCHAR(60)">
				<constraints nullable="false" />
			</column>
			<column name="entity_class" type="VARCHAR(255)" />
		</createTable>

		<addNotNullConstraint tableName="ADM_SECURED_ENTITY" columnName="user_id" />
        <addNotNullConstraint tableName="ADM_SECURED_ENTITY" columnName="code" />
        <addNotNullConstraint tableName="ADM_SECURED_ENTITY" columnName="entity_class" />
		<addForeignKeyConstraint
        	constraintName="FK_SECURED_ENTITY_USER" 
        	referencedTableName="ADM_USER" 
        	baseColumnNames="USER_ID" 
        	baseTableName="ADM_SECURED_ENTITY"
            referencedColumnNames="ID" />
	</changeSet>
	
	<changeSet id="#1821_20160707" author="EdwardLegaspi">
		<addColumn tableName="cat_offer_template">
			<column name="valid_from" type="TIMESTAMP WITHOUT TIME ZONE"></column>
			<column name="valid_to" type="TIMESTAMP WITHOUT TIME ZONE"></column>
		</addColumn>
		<addColumn tableName="cat_offer_serv_templates">
			<column name="valid_from" type="TIMESTAMP WITHOUT TIME ZONE"></column>
			<column name="valid_to" type="TIMESTAMP WITHOUT TIME ZONE"></column>
		</addColumn>
	</changeSet>
	
	<changeSet id="#1821_20160711" author="EdwardLegaspi">
		<addColumn tableName="cat_offer_template">
			<column name="image_content_type" type="VARCHAR(50)" />
		</addColumn>
	</changeSet>	
<changeSet id="#1774_20160725" author="smichea">
		<addColumn tableName="cat_price_plan_matrix">
			<column name="script_instance_id" type="BIGINT" />
        </addColumn>
		<addForeignKeyConstraint baseColumnNames="script_instance_id"
			baseTableName="cat_price_plan_matrix" constraintName="fk_priceplan_script"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_script_instance" />
	</changeSet>  
	<changeSet id="#1889_20160729" author="Mbarek">
	    <addColumn tableName="BILLING_TAX">
        <column name="UUID" type="VARCHAR(50)"/>
		</addColumn>
	</changeSet>
     <changeSet id="#1890_20160801" author="Mbarek">
	      <addColumn tableName="BILLING_CYCLE">
          <column name="UUID" type="VARCHAR(50)"/>
		</addColumn>
		<addColumn tableName="BILLING_INVOICE_CONFIGURATION">
			<column name="DISPLAY_BILLING_CYCLE" type="BOOL" defaultValueBoolean="false"></column> 
		</addColumn>
	</changeSet>
	
      <changeSet id="#1890_#1889_UIID_20160801" author="Mbarek">
         <sql>update BILLING_TAX set UUID ='TAX-'|| id </sql>   
        <sql>update BILLING_CYCLE set UUID ='BillingCycle-'|| id </sql> 
    </changeSet>  	

    <changeSet author="anasseh (generated)" id="#1841_13072016-1">
        <createSequence sequenceName="wf_action_seq"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-2">
        <createSequence sequenceName="wf_transition_seq"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-3">
        <createSequence sequenceName="wf_workflow_seq"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-4">
        <createTable tableName="wf_action">
            <column name="id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="INT4"/>
            <column name="disabled" type="BOOL">
                <constraints nullable="false"/>
            </column>
            <column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="TIMESTAMP WITHOUT TIME ZONE"/>
            <column name="action_el" type="VARCHAR(2000)"/>
            <column name="condition_el" type="VARCHAR(2000)"/>
            <column name="priority" type="INT4"/>
            <column name="provider_id" type="BIGINT"/>
            <column name="creator_id" type="BIGINT"/>
            <column name="updater_id" type="BIGINT"/>
            <column name="wf_transition_id" type="BIGINT"/>
        </createTable>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-5">
        <createTable tableName="wf_transition">
            <column name="id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="INT4"/>
            <column name="disabled" type="BOOL">
                <constraints nullable="false"/>
            </column>
            <column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="TIMESTAMP WITHOUT TIME ZONE"/>
            <column name="condition_el" type="VARCHAR(2000)"/>
            <column name="from_status" type="VARCHAR(255)"/>
            <column name="to_status" type="VARCHAR(255)"/>
            <column name="provider_id" type="BIGINT"/>
            <column name="creator_id" type="BIGINT"/>
            <column name="updater_id" type="BIGINT"/>
            <column name="workflow_id" type="BIGINT"/>
        </createTable>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-6">
        <createTable tableName="wf_workflow">
            <column name="id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="INT4"/>
            <column name="disabled" type="BOOL">
                <constraints nullable="false"/>
            </column>
            <column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="TIMESTAMP WITHOUT TIME ZONE"/>
            <column name="code" type="VARCHAR(60)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="VARCHAR(100)"/>
            <column name="enable_hostory" type="BOOL"/>
            <column name="export_lot" type="BOOL"/>
            <column name="status" type="VARCHAR(255)"/>
            <column name="wf_type" type="VARCHAR(255)"/>
            <column name="provider_id" type="BIGINT"/>
            <column name="creator_id" type="BIGINT"/>
            <column name="updater_id" type="BIGINT"/>
        </createTable>
    </changeSet>

   <changeSet author="anasseh (generated)" id="#1841_13072016-165">
        <dropForeignKeyConstraint  baseTableName="ar_action_dunning" constraintName="fk_r8q3phft4xgm8lbfu6i7lo3kx" />
    </changeSet>   
    
    <changeSet author="anasseh (generated)" id="#1841_13072016-18">
        <addPrimaryKey columnNames="id" constraintName="wf_action_pkey" tableName="wf_action"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-19">
        <addPrimaryKey columnNames="id" constraintName="wf_transition_pkey" tableName="wf_transition"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-20">
        <addPrimaryKey columnNames="id" constraintName="wf_workflow_pkey" tableName="wf_workflow"/>
    </changeSet>
 
    <changeSet author="anasseh (generated)" id="#1841_13072016-23">
        <addUniqueConstraint columnNames="from_status, to_status, workflow_id, provider_id" constraintName="uk_7xdivt2yngk5mmjfdy2x73cad" deferrable="false" disabled="false" initiallyDeferred="false" tableName="wf_transition"/>
    </changeSet>

    <changeSet author="anasseh (generated)" id="#1841_13072016-25">
        <addUniqueConstraint columnNames="priority, wf_transition_id, provider_id" constraintName="uk_cr97e5dxkl6ps0coltjw6i28y" deferrable="false" disabled="false" initiallyDeferred="false" tableName="wf_action"/>
    </changeSet>

    <changeSet author="anasseh (generated)" id="#1841_13072016-27">
        <addUniqueConstraint columnNames="provider_id, code" constraintName="uk_j8v4x5olh5um1g7y5vnsayrka" deferrable="false" disabled="false" initiallyDeferred="false" tableName="wf_workflow"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-31">
        <addForeignKeyConstraint baseColumnNames="provider_id" baseTableName="wf_workflow" constraintName="fk_30dgqb4bqjvftqov1dmjetr56" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-32">
        <addForeignKeyConstraint baseColumnNames="updater_id" baseTableName="wf_workflow" constraintName="fk_59d2mctermakats2qqmqnt0p" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-35">
        <addForeignKeyConstraint baseColumnNames="workflow_id" baseTableName="wf_transition" constraintName="fk_6wxr8klsgmr7ko8lpg0ftvtpy" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="wf_workflow"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-36">
        <addForeignKeyConstraint baseColumnNames="provider_id" baseTableName="wf_transition" constraintName="fk_79r4px1y8ue4cphslp2j35y65" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-40">
        <addForeignKeyConstraint baseColumnNames="creator_id" baseTableName="wf_transition" constraintName="fk_83p4dgib7kijghh3w89ero3ep" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-45">
        <addForeignKeyConstraint baseColumnNames="wf_transition_id" baseTableName="wf_action" constraintName="fk_bh5loyx0bx3tm8yu3ul2ycco0" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="wf_transition"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-48">
        <addForeignKeyConstraint baseColumnNames="updater_id" baseTableName="wf_action" constraintName="fk_do5fekc1wyiqn59lbedxeppyr" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-55">
        <addForeignKeyConstraint baseColumnNames="creator_id" baseTableName="wf_action" constraintName="fk_il9g2ryuq1wxbct7bler61t02" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-56">
        <addForeignKeyConstraint baseColumnNames="creator_id" baseTableName="wf_workflow" constraintName="fk_jjfi7wwmfajc14c0ji4pp9tmc" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-57">
        <addForeignKeyConstraint baseColumnNames="updater_id" baseTableName="wf_transition" constraintName="fk_lk8axoo3cfhip52gnv02mn9eu" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-61">
        <addForeignKeyConstraint baseColumnNames="provider_id" baseTableName="wf_action" constraintName="fk_q7dvcjiuap29yhvq884lt0die" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-63">
        <dropForeignKeyConstraint baseTableName="ar_dunning_plan" constraintName="fk_24c5wf8u9a35yf8uutjf5qwwf"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-64">
        <dropForeignKeyConstraint baseTableName="ar_dunning_plan" constraintName="fk_3nhld7nla1pv1t8eejdl4dn6p"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-69">
        <dropForeignKeyConstraint baseTableName="ar_action_plan_item" constraintName="fk_78p10vstesm3xr605s46qn3gq"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-70">
        <dropForeignKeyConstraint baseTableName="ar_action_plan_item" constraintName="fk_8q1jrqq9e8xru7m27nbwrxp3k"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-72">
        <dropForeignKeyConstraint baseTableName="ar_dunning_plan" constraintName="fk_ar_credit_category_ar_dunning_plan"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-80">
        <dropForeignKeyConstraint baseTableName="ar_dunning_plan_transition" constraintName="fk_ecur7dwit9crb6cbhlubxs3jn"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-81">
        <dropForeignKeyConstraint baseTableName="ar_dunning_plan_transition" constraintName="fk_eu7ekseo196cq1qgyg7xm7vs5"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-82">
        <dropForeignKeyConstraint baseTableName="ar_dunning_plan_transition" constraintName="fk_gc1m3d2m0dsqcaek8rxrk0u87"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-84">
        <dropForeignKeyConstraint baseTableName="ar_dunning_plan" constraintName="fk_j0vlitgsqwnnkry67xwuead15"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-86">
        <dropForeignKeyConstraint baseTableName="ar_dunning_plan_transition" constraintName="fk_jpipfg980fcv7pq4s9tnb35ik"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-87">
        <dropForeignKeyConstraint baseTableName="ar_action_plan_item" constraintName="fk_k9j7i31wmyhrw11lyxkdnpymr"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-95">
        <dropForeignKeyConstraint baseTableName="ar_action_plan_item" constraintName="fk_n5ax6w0qt9pum3oc3n2b3hgxw"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-101">
        <dropUniqueConstraint constraintName="uk_ewwxy8ieo179rif5ud8hduqkt" tableName="ar_dunning_plan_transition"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-103">
        <dropUniqueConstraint constraintName="uk_qn6vfgeg5g2y4pb9y6qb8ogjo" tableName="ar_dunning_plan"/>
    </changeSet>   
    <changeSet author="anasseh (generated)" id="#1841_13072016-104">
        <dropTable tableName="ar_action_plan_item"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-105">
        <dropTable tableName="ar_dunning_plan"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-106">
        <dropTable tableName="ar_dunning_plan_transition"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-144">
        <dropSequence sequenceName="ar_dunning_plan_seq"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-145">
        <dropSequence sequenceName="ar_dunning_plan_transition_seq"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1841_13072016-164">       
        <addForeignKeyConstraint baseColumnNames="action_plan_item_id" baseTableName="ar_action_dunning" constraintName="fk_r8q3phft4xgm8lbfu6i7lo3kx" referencedColumnNames="id" referencedTableName="wf_action"/>
    </changeSet>	  
    
    <changeSet id="#1885_20160815_service_entity" author="EdwardPLegaspi">
    	<addColumn tableName="cat_service_template">
    		<column name="image" type="oid" />
			<column name="image_content_type" type="VARCHAR(50)" />
    	</addColumn>
    </changeSet>  
    	
    <changeSet id="#1886_20160728_offer_service" author="EdwardPLegaspi">
    	<addColumn tableName="cat_offer_template">
    		<column name="long_description" type="TEXT"></column>
    	</addColumn>
    	<addColumn tableName="cat_service_template">
    		<column name="long_description" type="TEXT"></column>
    	</addColumn>
    </changeSet>     
    	
    <changeSet author="pbach (generated)" id="#1863_04082016-165">
        <createTable tableName="hierarchy_entity">
            <column name="id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="INT4"/>
            <column name="disabled" type="BOOL">
                <constraints nullable="false"/>
            </column>
            <column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="TIMESTAMP WITHOUT TIME ZONE"/>
            <column name="code" type="VARCHAR(60)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="VARCHAR(100)"/>
            <column name="hierarchy_type" type="VARCHAR(10)"/>
            <column name="parent_id" type="BIGINT"/>
            <column name="order_level" type="BIGINT"/>
            <column name="provider_id" type="BIGINT"/>
            <column name="creator_id" type="BIGINT"/>
            <column name="updater_id" type="BIGINT"/>
        </createTable>
        
        <createSequence sequenceName="hierarchy_entity_seq" />
        <addPrimaryKey columnNames="id" constraintName="hierarchy_entity_pkey"
                       tableName="hierarchy_entity" />
        <addForeignKeyConstraint baseColumnNames="provider_id"
                                 baseTableName="hierarchy_entity" constraintName="fk_hierarchy_entity_crm_provider"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />

        <addForeignKeyConstraint baseColumnNames="creator_id"
                                 baseTableName="hierarchy_entity" constraintName="fk_creator_hierarchy_entity_adm_user"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />

        <addForeignKeyConstraint baseColumnNames="updater_id"
                                 baseTableName="hierarchy_entity" constraintName="fk_updater_hierarchy_entity_adm_user"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
        <addForeignKeyConstraint baseColumnNames="parent_id"
                                 baseTableName="hierarchy_entity" constraintName="fk_hierarchy_entity_hierarchy_entity"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="hierarchy_entity" />
        <addUniqueConstraint columnNames="code, hierarchy_type, provider_id" constraintName="uk_code_hierarchy_provider" deferrable="false" disabled="false"
                             initiallyDeferred="false" tableName="hierarchy_entity" />

        <addColumn tableName="adm_user">
            <column name="hierarchy_level_id" type="BIGINT" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="hierarchy_level_id"
                                 baseTableName="adm_user" constraintName="fk_hierarchy_level_adm_user_hierarchy_entity"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="hierarchy_entity" />
    </changeSet>
    	
    <changeSet id="#1842_20160720" author="TyshanShi">
		<sql>update crm_provider_contact a set address_country =(select description_en from adm_country c where 
			lower(c.country_code)=lower(a.address_country) or lower(c.description_en)=lower(a.address_country))
			where a.address_country in (select c.country_code from adm_country c);
		</sql>
		<sql>update account_entity a set address_country =(select description_en from adm_country c where 
			lower(c.country_code)=lower(a.address_country) or lower(c.description_en)=lower(a.address_country)) 
			where a.address_country in (select c.country_code from adm_country c);
		</sql>
	</changeSet>
    	
</databaseChangeLog>