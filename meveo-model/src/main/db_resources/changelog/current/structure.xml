<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.2.xsd">

	<changeSet author="EdwardLegaspi" id="#1087_20150922">
		<createTable tableName="meveo_filter_parameter">
			<column name="id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="version" type="INT4" />
			<column name="disabled" type="BOOL">
				<constraints nullable="false" />
			</column>
			<column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="TIMESTAMP WITHOUT TIME ZONE" />
			<column name="provider_id" type="BIGINT" />
			<column name="creator_id" type="BIGINT" />
			<column name="updater_id" type="BIGINT" />
			<column name="code" type="VARCHAR(60)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="VARCHAR(100)" />
			<column name="default_value" type="VARCHAR(50)" />
			<column name="value_required" type="BOOL" />
			<column name="field_type" type="VARCHAR(255)" />
			<column name="entity_clazz" type="VARCHAR(255)" />
			<column name="filter_id" type="BIGINT" />
		</createTable>

		<addPrimaryKey columnNames="id" constraintName="meveo_filter_parameter_pkey"
			tableName="meveo_filter_parameter" />

		<addForeignKeyConstraint baseColumnNames="provider_id"
			baseTableName="meveo_filter_parameter" constraintName="fk_meveo_filter_parameter_crm_provider"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
		
		<addForeignKeyConstraint baseColumnNames="creator_id"
			baseTableName="meveo_filter_parameter" constraintName="fk_creator_meveo_filter_parameter_adm_user"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
		
		<addForeignKeyConstraint baseColumnNames="updater_id"
			baseTableName="meveo_filter_parameter" constraintName="fk_updater_meveo_filter_parameter_adm_user"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
		
		<addForeignKeyConstraint baseColumnNames="filter_id"
			baseTableName="meveo_filter_parameter" constraintName="fk_meveo_filter_parameter_meveo_filter"
			deferrable="false" initiallyDeferred="false" onDelete="CASCADE"
			onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="meveo_filter" />

		<createTable tableName="meveo_filter_parameter_list_val">
			<column name="filterparameter_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="listvalues" type="VARCHAR(255)" />
			<column name="listvalues_key" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createSequence sequenceName="meveo_filter_parameter_seq" />
	</changeSet>

	<changeSet author="anasseh" id="20150928_text">
     	<modifyDataType columnName="string_value" newDataType="text"   tableName="CRM_CUSTOM_FIELD_INST"/>
     </changeSet>
    
    <changeSet author="AndriusKarpavicius" id="#1094_20150929">
		<addColumn tableName="CRM_CUSTOM_FIELD_INST">
			<column name="seller_id" type="BIGINT" />
		</addColumn>    
    
    	<addForeignKeyConstraint constraintName="fk_seller_id_crm_custom_field_inst"
			referencedTableName="CRM_SELLER" baseColumnNames="seller_id"
			baseTableName="CRM_CUSTOM_FIELD_INST" referencedColumnNames="id" />
    </changeSet>

    <changeSet author="AndriusKarpavicius" id="#1123_20151006">
        <dropColumn tableName="MEVEO_JOB_INSTANCE" columnName="user_id"/>
    </changeSet>
	 <changeSet author="anasseh" id="#1117_20151005">
		    <addColumn tableName="BILLING_CYCLE">
	            <column name="INVOICING_THRESHOLD" type="numeric(23, 12)" />
	        </addColumn>	
	</changeSet>       
    <changeSet author="anasseh" id="20151009_1149">
        <modifyDataType columnName="SELECTED_BILLING_ACCOUNTS" newDataType="text"   tableName="BILLING_BILLING_RUN"/>
     </changeSet>
   	<changeSet author="anasseh" id="20151013_1165">
     	<modifyDataType columnName="MESSAGE" newDataType="text"   tableName="MEVEO_SCRIPT_INSTANCE_ERROR"/>
     </changeSet>      
     
     <changeSet author="EdwardLegaspi" id="#1105_20150930">
		<addColumn tableName="ar_account_operation">
			<column name="credit_note_date" type="TIMESTAMP WITHOUT TIME ZONE"></column>
		</addColumn>

		<createTable tableName="billing_credit_note">
			<column name="id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="version" type="INT4" />
			<column name="disabled" type="BOOL">
				<constraints nullable="false" />
			</column>
			<column name="code" type="VARCHAR(60)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="VARCHAR(100)" />
			<column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="TIMESTAMP WITHOUT TIME ZONE" />
			<column name="provider_id" type="BIGINT" />
			<column name="creator_id" type="BIGINT" />
			<column name="updater_id" type="BIGINT" />
			<column name="billing_account_id" type="BIGINT" />
			<column name="recorded_invoice_id" type="BIGINT" />
			<column name="invoice_id" type="BIGINT" />
			<column name="credit_note_date" type="TIMESTAMP WITHOUT TIME ZONE"></column>
			<column name="due_date" type="TIMESTAMP WITHOUT TIME ZONE"></column>
			<column name="amount_without_tax" type="numeric(23, 12)" />
			<column name="amount_with_tax" type="numeric(23, 12)" />
			<column name="net_to_pay" type="numeric(23, 12)" />
		</createTable>

		<createSequence sequenceName="billing_credit_note_seq"
			startValue="1" />
		<addPrimaryKey columnNames="id" constraintName="billing_credit_note_pkey"
			tableName="billing_credit_note" />
		<addForeignKeyConstraint baseColumnNames="provider_id"
			baseTableName="billing_credit_note" constraintName="fk_billing_credit_note_crm_provider"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
		<addForeignKeyConstraint baseColumnNames="creator_id"
			baseTableName="billing_credit_note" constraintName="fk_billing_credit_note_adm_user_creator"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
		<addForeignKeyConstraint baseColumnNames="updater_id"
			baseTableName="billing_credit_note" constraintName="fk_billing_credit_note_adm_user_updater"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
		<addForeignKeyConstraint baseColumnNames="billing_account_id"
			baseTableName="billing_credit_note" constraintName="fk_billing_credit_note_billing_account"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />
		<addForeignKeyConstraint baseColumnNames="recorded_invoice_id"
			baseTableName="billing_credit_note" constraintName="fk_billing_credit_note_recorded_invoice"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_account_operation" />
		<addForeignKeyConstraint baseColumnNames="invoice_id"
			baseTableName="billing_credit_note" constraintName="fk_billing_credit_note_invoice"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice" />

		<createTable tableName="billing_credit_note_tax_amt">
			<column name="creditnote_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="taxamounts_key" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="taxamounts" type="numeric(23, 12)" />
		</createTable>

		<addPrimaryKey columnNames="creditnote_id, taxamounts_key"
			constraintName="billing_credit_note_tax_amt_pkey" tableName="billing_credit_note_tax_amt" />
		<addForeignKeyConstraint baseColumnNames="creditnote_id"
			baseTableName="billing_credit_note_tax_amt" constraintName="fk_billing_credit_note_tax_amt_credit_note"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_credit_note" />

		<createTable tableName="billing_credit_note_line">
			<column name="id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="version" type="INT4" />
			<column name="provider_id" type="BIGINT" />
			<column name="description" type="VARCHAR(255)" />
			<column name="credit_note_id" type="BIGINT" />
			<column name="invoice_sub_category" type="BIGINT" />
			<column name="amount_without_tax" type="numeric(23, 12)" />
			<column name="tax_amount" type="numeric(23, 12)" />
			<column name="amount_with_tax" type="numeric(23, 12)" />
		</createTable>

		<createSequence sequenceName="billing_credit_note_line_seq"
			startValue="1" />
		<addPrimaryKey columnNames="id"
			constraintName="billing_credit_note_line_pkey" tableName="billing_credit_note_line" />
		<addForeignKeyConstraint baseColumnNames="provider_id"
			baseTableName="billing_credit_note_line" constraintName="fk_billing_credit_note_line_crm_provider"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
		<addForeignKeyConstraint baseColumnNames="credit_note_id"
			baseTableName="billing_credit_note_line" constraintName="fk_billing_credit_note_line_credit_note"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_credit_note" />
		<addForeignKeyConstraint baseColumnNames="invoice_sub_category"
			baseTableName="billing_credit_note_line" constraintName="fk_billing_credit_note_line_invoice_sub_cat"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_sub_cat" />
	</changeSet>
     
	<changeSet author="EdwardLegaspi" id="#1110_20151002">
		<addColumn tableName="billing_invoice">
			<column name="code" type="VARCHAR(60)">
				<constraints nullable="true" />
			</column>
			<column name="description" type="VARCHAR(100)" />
		</addColumn>

		<sql>UPDATE billing_invoice SET code=concat('ocb_id_', id)</sql>

		<addNotNullConstraint columnDataType="VARCHAR(60)"
			columnName="code" tableName="billing_invoice" />
	</changeSet>  
	
    <changeSet id="#1150_20151013" author="Mbarek">
	<addColumn tableName="BILLING_INVOICE_CONFIGURATION">
	<column name="display_provider" type="BOOL" defaultValueBoolean="false"></column>
	</addColumn>
	</changeSet>

    <changeSet id="#1101_20151021" author="AndriusKarpavicius">
        <createSequence sequenceName="CRM_CUSTOM_FIELD_FIELDS_SEQ"/>
        <createTable tableName="CRM_CUSTOM_FIELD_FIELDS">
            <column name="id" type="BIGINT">
                <constraints nullable="false"  />
            </column>
            <column name="version" type="INT4" />        
            <column name="provider_id" type="BIGINT" />
            <column name="UUID" type="VARCHAR(60)" >
                <constraints nullable="false"/>
            </column> 
        </createTable>
        
        <addColumn tableName="CRM_CUSTOM_FIELD_INST">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        
        <addPrimaryKey columnNames="id" constraintName="crm_custom_field_fields_pkey"
            tableName="CRM_CUSTOM_FIELD_FIELDS" />
            
        <addForeignKeyConstraint constraintName="fk_crm_custom_field_inst_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="CRM_CUSTOM_FIELD_INST" referencedColumnNames="id" />
        
        <addColumn tableName="MEDINA_ACCESS">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>        
        <addColumn tableName="CRM_PROVIDER">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="ACCOUNT_ENTITY">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="CAT_CHARGE_TEMPLATE">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="MEVEO_JOB_INSTANCE">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="CAT_OFFER_TEMPLATE">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="CRM_SELLER">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="CAT_SERVICE_TEMPLATE">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="BILLING_SUBSCRIPTION">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        
        <addForeignKeyConstraint constraintName="fk_medina_access_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="MEDINA_ACCESS" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_crm_provider_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="CRM_PROVIDER" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_account_entity_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="ACCOUNT_ENTITY" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_cat_charge_template_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="CAT_CHARGE_TEMPLATE" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_meveo_job_instance_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="MEVEO_JOB_INSTANCE" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_cat_offer_template_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="CAT_OFFER_TEMPLATE" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_crm_seller_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="CRM_SELLER" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_cat_service_template_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="CAT_SERVICE_TEMPLATE" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_billing_subscription_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="BILLING_SUBSCRIPTION" referencedColumnNames="id" />
        
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'provider_'||cfi_ent_id, cfi_ent_id from (select distinct provider_id as cfi_ent_id from crm_custom_field_inst where provider_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='provider_'||crm_custom_field_inst.provider_id) where provider_id is not null;
            update crm_provider set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='provider_'||crm_provider.id);
        </sql>        
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'access_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct medina_access.id as cfi_ent_id, medina_access.provider_id as cfi_ent_provider_id from crm_custom_field_inst join medina_access on crm_custom_field_inst.access_id =medina_access.id and crm_custom_field_inst.access_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='access_'||crm_custom_field_inst.access_id) where access_id is not null;
            update medina_access set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='access_'||medina_access.id);
        </sql>
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'charge_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct CAT_CHARGE_TEMPLATE.id as cfi_ent_id, CAT_CHARGE_TEMPLATE.provider_id as cfi_ent_provider_id from crm_custom_field_inst join CAT_CHARGE_TEMPLATE on crm_custom_field_inst.charge_template_id =CAT_CHARGE_TEMPLATE.id and crm_custom_field_inst.charge_template_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='charge_'||crm_custom_field_inst.charge_template_id) where charge_template_id is not null;
            update CAT_CHARGE_TEMPLATE set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='charge_'||CAT_CHARGE_TEMPLATE.id);
        </sql>
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'offer_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct CAT_OFFER_TEMPLATE.id as cfi_ent_id, CAT_OFFER_TEMPLATE.provider_id as cfi_ent_provider_id from crm_custom_field_inst join CAT_OFFER_TEMPLATE on crm_custom_field_inst.offer_template_id =CAT_OFFER_TEMPLATE.id and crm_custom_field_inst.offer_template_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='offer_'||crm_custom_field_inst.offer_template_id) where offer_template_id is not null;
            update CAT_OFFER_TEMPLATE set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='offer_'||CAT_OFFER_TEMPLATE.id);
        </sql>
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'service_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct CAT_SERVICE_TEMPLATE.id as cfi_ent_id, CAT_SERVICE_TEMPLATE.provider_id as cfi_ent_provider_id from crm_custom_field_inst join CAT_SERVICE_TEMPLATE on crm_custom_field_inst.service_template_id =CAT_SERVICE_TEMPLATE.id and crm_custom_field_inst.service_template_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='service_'||crm_custom_field_inst.service_template_id) where service_template_id is not null;
            update CAT_SERVICE_TEMPLATE set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='service_'||CAT_SERVICE_TEMPLATE.id);
        </sql>
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'subs_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct BILLING_SUBSCRIPTION.id as cfi_ent_id, BILLING_SUBSCRIPTION.provider_id as cfi_ent_provider_id from crm_custom_field_inst join BILLING_SUBSCRIPTION on crm_custom_field_inst.subscription_id =BILLING_SUBSCRIPTION.id and crm_custom_field_inst.subscription_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='subs_'||crm_custom_field_inst.subscription_id) where subscription_id is not null;
            update BILLING_SUBSCRIPTION set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='subs_'||BILLING_SUBSCRIPTION.id);
        </sql>
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'job_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct MEVEO_JOB_INSTANCE.id as cfi_ent_id, MEVEO_JOB_INSTANCE.provider_id as cfi_ent_provider_id from crm_custom_field_inst join MEVEO_JOB_INSTANCE on crm_custom_field_inst.job_instance_id =MEVEO_JOB_INSTANCE.id and crm_custom_field_inst.job_instance_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='job_'||crm_custom_field_inst.job_instance_id) where job_instance_id is not null;
            update MEVEO_JOB_INSTANCE set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='job_'||MEVEO_JOB_INSTANCE.id);
        </sql>
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'seller_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct CRM_SELLER.id as cfi_ent_id, CRM_SELLER.provider_id as cfi_ent_provider_id from crm_custom_field_inst join CRM_SELLER on crm_custom_field_inst.seller_id =CRM_SELLER.id and crm_custom_field_inst.seller_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='seller_'||crm_custom_field_inst.seller_id) where seller_id is not null;
            update CRM_SELLER set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='seller_'||CRM_SELLER.id);        
        </sql>
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'account_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct ACCOUNT_ENTITY.id as cfi_ent_id, ACCOUNT_ENTITY.provider_id as cfi_ent_provider_id from crm_custom_field_inst join ACCOUNT_ENTITY on crm_custom_field_inst.account_id =ACCOUNT_ENTITY.id and crm_custom_field_inst.account_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='account_'||crm_custom_field_inst.account_id) where account_id is not null;
            update ACCOUNT_ENTITY set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='account_'||ACCOUNT_ENTITY.id);
        </sql>
        
        <addNotNullConstraint tableName="CRM_CUSTOM_FIELD_INST" columnName="CFF_ID"/>
        
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="provider_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="access_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="charge_template_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="offer_template_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="service_template_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="subscription_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="job_instance_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="seller_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="account_id"/>
                
        <addColumn tableName="CRM_CUSTOM_FIELD_TMPL">
            <column name="APPLIES_TO" type="VARCHAR(100)"/>
        </addColumn>
        
        <sql>
            update CRM_CUSTOM_FIELD_TMPL set applies_to = account_type where account_type&lt;&gt; 'TIMER';
            update CRM_CUSTOM_FIELD_TMPL set applies_to = 'JOB_'|| SUBSTR(code, 0, strpos(code, '_')) where account_type= 'TIMER';
            update CRM_CUSTOM_FIELD_TMPL set code = 'nbRuns' where right(code,7)='_nbRuns' and account_type= 'TIMER';
            update CRM_CUSTOM_FIELD_TMPL set code = 'waitingMillis' where right(code,14)='_waitingMillis' and account_type= 'TIMER';        
        </sql>
        
        <sql>
            update CRM_CUSTOM_FIELD_TMPL set storage_type='SINGLE' where storage_type is null;
        </sql>
        
        <addNotNullConstraint tableName="CRM_CUSTOM_FIELD_TMPL" columnName="APPLIES_TO"/>
        <addNotNullConstraint tableName="CRM_CUSTOM_FIELD_TMPL" columnName="field_type"/>
        <addNotNullConstraint tableName="CRM_CUSTOM_FIELD_TMPL" columnName="storage_type"/>
        
        <dropColumn tableName="CRM_CUSTOM_FIELD_TMPL" columnName="account_type"/>
        
    </changeSet>         

	<changeSet author="EdwardLegaspi" id="#1147_20151009">
		<addColumn tableName="crm_provider">
			<column name="credit_note_prefix" type="VARCHAR(255)" />
			<column name="current_credit_note_nb" type="BIGINT" />
		</addColumn>
		<addColumn tableName="crm_seller">
			<column name="credit_note_prefix" type="VARCHAR(255)" />
			<column name="current_credit_note_nb" type="BIGINT" />
		</addColumn>
	</changeSet>

	<changeSet id="#1105_20151009" author="EdwardLegaspi">
		<dropForeignKeyConstraint baseTableName="billing_credit_note"
			constraintName="fk_billing_credit_note_recorded_invoice" />
		<dropColumn tableName="billing_credit_note" columnName="recorded_invoice_id" />

		<addColumn tableName="billing_credit_note">
			<column name="recorded_credit_note_id" type="BIGINT" />
		</addColumn>
		<addForeignKeyConstraint baseColumnNames="recorded_credit_note_id"
			baseTableName="billing_credit_note" constraintName="fk_billing_credit_note_recorded_credit_note"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_account_operation" />
	</changeSet>

	<changeSet id="#1138_20151009" author="EdwardLegaspi">
		<addColumn tableName="crm_provider">
			<column name="credit_note_sequence_size" type="INT4" />
		</addColumn>
		<addColumn tableName="crm_seller">
			<column name="credit_note_sequence_size" type="INT4" />
		</addColumn>

		<sql>UPDATE crm_provider SET credit_note_sequence_size=9;</sql>
	</changeSet>

	<changeSet id="#REVERT_CREDIT_NOTE_20151014" author="EdwardLegaspi">
		<dropForeignKeyConstraint baseTableName="billing_credit_note"
			constraintName="fk_billing_credit_note_crm_provider" />
		<dropForeignKeyConstraint baseTableName="billing_credit_note"
			constraintName="fk_billing_credit_note_adm_user_creator" />
		<dropForeignKeyConstraint baseTableName="billing_credit_note"
			constraintName="fk_billing_credit_note_adm_user_updater" />
		<dropForeignKeyConstraint baseTableName="billing_credit_note"
			constraintName="fk_billing_credit_note_billing_account" />
		<dropForeignKeyConstraint baseTableName="billing_credit_note"
			constraintName="fk_billing_credit_note_invoice" />
		<dropForeignKeyConstraint baseTableName="billing_credit_note_tax_amt"
			constraintName="fk_billing_credit_note_tax_amt_credit_note" />
		<dropForeignKeyConstraint baseTableName="billing_credit_note_line"
			constraintName="fk_billing_credit_note_line_crm_provider" />
		<dropForeignKeyConstraint baseTableName="billing_credit_note_line"
			constraintName="fk_billing_credit_note_line_credit_note" />
		<dropForeignKeyConstraint baseTableName="billing_credit_note_line"
			constraintName="fk_billing_credit_note_line_invoice_sub_cat" />
		<dropForeignKeyConstraint baseTableName="billing_credit_note"
			constraintName="fk_billing_credit_note_recorded_credit_note" />

		<dropPrimaryKey tableName="billing_credit_note"
			constraintName="billing_credit_note_pkey" />
		<dropPrimaryKey tableName="billing_credit_note_line"
			constraintName="billing_credit_note_line_pkey" />
		<dropPrimaryKey tableName="billing_credit_note_tax_amt"
			constraintName="billing_credit_note_tax_amt_pkey" />

		<dropSequence sequenceName="billing_credit_note_seq" />
		<dropSequence sequenceName="billing_credit_note_line_seq" />

		<dropColumn tableName="crm_provider" columnName="credit_note_prefix" />
		<dropColumn tableName="crm_provider" columnName="current_credit_note_nb" />
		<dropColumn tableName="crm_provider" columnName="credit_note_sequence_size" />

		<dropColumn tableName="crm_seller" columnName="credit_note_prefix" />
		<dropColumn tableName="crm_seller" columnName="current_credit_note_nb" />
		<dropColumn tableName="crm_seller" columnName="credit_note_sequence_size" />

		<dropColumn tableName="ar_account_operation" columnName="credit_note_date" />

		<dropTable tableName="billing_credit_note_tax_amt" />
		<dropTable tableName="billing_credit_note_line" />
		<dropTable tableName="billing_credit_note" />
	</changeSet>

	<changeSet id="#1167_20151015" author="EdwardLegaspi">
		<addColumn tableName="crm_provider">
			<column name="invoice_adjustment_prefix" type="VARCHAR(255)" />
			<column name="current_invoice_adjustment_nb" type="BIGINT" />
			<column name="invoice_adjustment_sequence_size" type="INT4" />
		</addColumn>
		<addColumn tableName="crm_seller">
			<column name="invoice_adjustment_prefix" type="VARCHAR(255)" />
			<column name="current_invoice_adjustment_nb" type="BIGINT" />
			<column name="invoice_adjustment_sequence_size" type="INT4" />
		</addColumn>

		<addColumn tableName="billing_invoice">
			<column name="detailed_invoice" type="boolean" defaultValue="true" />
			<column name="invoice_id" type="BIGINT" />
		</addColumn>

		<addForeignKeyConstraint constraintName="fk_billing_invoice_adjusted_invoice"
			referencedTableName="billing_invoice" baseColumnNames="invoice_id"
			baseTableName="billing_invoice" referencedColumnNames="id" />

		<sql>UPDATE billing_invoice SET invoice_type='COMMERCIAL'</sql>
	</changeSet>

	<changeSet id="#1170_20151020" author="EdwardLegaspi">
		<addColumn tableName="billing_invoice_configuration">
			<column name="display_detail" type="BOOL" defaultValueBoolean="true"></column>
		</addColumn>
	</changeSet>

	<changeSet id="#1184_20151022" author="EdwardLegaspi">
		<addColumn tableName="billing_rated_transaction">
			<column name="adjusted_rated_tx" type="BIGINT" />
		</addColumn>

		<addForeignKeyConstraint
			constraintName="fk_billing_rated_transaction_rated_transaction"
			referencedTableName="billing_rated_transaction" baseColumnNames="adjusted_rated_tx"
			baseTableName="billing_rated_transaction" referencedColumnNames="id" />		
	</changeSet>
	
	<changeSet id="#1134-20151026" author="Mbarek">
		<addColumn tableName="crm_provider"> 
			<column name="INVOICE_SEQUENCE_SIZE" type="INT4" defaultValue="9" />
		</addColumn>
		<addColumn tableName="crm_seller"> 
			<column name="INVOICE_SEQUENCE_SIZE" type="INT4" defaultValue="9" />
		</addColumn>
	</changeSet>

    <changeSet id="#1101_20151022" author="AndriusKarpavicius">
    
        <addForeignKeyConstraint baseColumnNames="provider_id"
            baseTableName="crm_custom_field_fields" constraintName="fk_crm_custom_field_fields_crm_provider"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
            
    </changeSet>
    
    <changeSet id="#1102_20151023" author="AndriusKarpavicius">
        <createSequence sequenceName="CUST_CET_SEQ"/>
        
        <createTable tableName="CUST_CET">
            <column name="id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="version" type="INT4" />
            <column name="disabled" type="BOOL">
                <constraints nullable="false" />
            </column>
            <column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="TIMESTAMP WITHOUT TIME ZONE" />
            <column name="description" type="VARCHAR(100)" />
            <column name="code" type="VARCHAR(50)" />
            <column name="provider_id" type="BIGINT" />
            <column name="creator_id" type="BIGINT" />
            <column name="updater_id" type="BIGINT" />
        </createTable>
    
        <addPrimaryKey columnNames="id" constraintName="cust_cet_pkey"
            tableName="cust_cet" />

        <addForeignKeyConstraint baseColumnNames="provider_id"
            baseTableName="cust_cet" constraintName="fk_cust_cet_crm_provider"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
        
        <addForeignKeyConstraint baseColumnNames="creator_id"
            baseTableName="cust_cet" constraintName="fk_creator_cust_cet_adm_user"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
        
        <addForeignKeyConstraint baseColumnNames="updater_id"
            baseTableName="cust_cet" constraintName="fk_updater_cust_cet_adm_user"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />        
    
    </changeSet>
</databaseChangeLog>