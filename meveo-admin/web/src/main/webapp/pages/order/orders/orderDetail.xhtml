<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:f="http://java.sun.com/jsf/core" xmlns:h="http://java.sun.com/jsf/html"
    xmlns:hftl="http://hftl.org" xmlns:p="http://primefaces.org/ui" xmlns:pe="http://primefaces.org/ui/extensions" template="/layout/template.xhtml">

    <ui:define name="metadata">
        <f:metadata>
            <f:viewParam name="objectId" value="#{orderBean.objectId}" />
            <f:viewParam name="tab" value="#{orderBean.activeTab}" />
        </f:metadata>
    </ui:define>

    <ui:define name="navigation">
        <ui:include src="/layout/navigation.xhtml" />
    </ui:define>

    <ui:define name="body">
        <pe:importEnum type="org.meveo.model.order.OrderStatusEnum" var="OrderStatusEnum" />
        <pe:importEnum type="org.meveo.model.order.OrderItemActionEnum" var="OrderItemActionEnum" />
        <p:panel>
            <h:form id="crumbmenuForm">
                <p:breadCrumb homeDisplay="text" id="crumbmenu">
                    <p:menuitem value="#{messages['menu.orders']}" disabled="true" />
                    <p:menuitem outcome="orders" value="#{messages['menu.orders']}" />
                </p:breadCrumb>
            </h:form>
        </p:panel>
        <hftl:formPanel formId="orderForm" label="#{messages['order.panel']}" backingBean="#{orderBean}" edit="#{orderBean.entity.status==OrderStatusEnum.IN_CREATION}"
            showEditButton="#{orderBean.entity.status==OrderStatusEnum.IN_CREATION}">
            <p:tabView id="tabView" activeIndex="#{orderBean.activeTab}">
                <p:tab title="#{messages['order.tab.order']}" id="tabOrder">

                    <hftl:formField label="#{messages['businessEntity.code']}" field="code" validateUnique="true" required="true" allowEdit="false" />
                    <hftl:formField label="#{messages['businessEntity.description']}" field="description" />
                    <hftl:formField label="#{messages['order.orderDate']}" field="orderDate" showOnNew="false" allowEdit="false" />
                    <hftl:formField label="#{messages['order.priority']}" field="priority" />
                    <hftl:formField label="#{messages['order.category']}" field="category" />

                    <hftl:formField label="#{messages['order.receivedFromApp']}" field="receivedFromApp" rendered="#{orderBean.entity.receivedFromApp!=null}" />
                    <hftl:formField label="#{messages['order.externalId']}" field="externalId" edit="false" rendered="#{orderBean.entity.receivedFromApp!=null}" />

                    <p:fieldset legend="#{messages['order.processingInstructions']}" styleClass="clearBoth">
                        <hftl:formField label="#{messages['order.deliveryInstructions']}" field="deliveryInstructions" />

                        <hftl:formField label="#{messages['order.requestedStartDate']}" field="requestedStartDate" />
                        <hftl:formField label="#{messages['order.requestedCompletionDate']}" field="requestedCompletionDate" />
                    </p:fieldset>
                    <p:fieldset legend="#{messages['order.processingStatus']}" styleClass="clearBoth" rendered="#{orderBean.entity.status!=OrderStatusEnum.IN_CREATION}">
                        <hftl:formField label="#{messages['commons.status']}" field="status" showOnNew="false" edit="false" />
                        <hftl:formField label="#{messages['order.statusMessage']}" field="statusMessage" rendered="#{orderBean.entity.statusMessage!=null}" />

                        <hftl:formField label="#{messages['order.routedTo']}" field="routedTo" rendered="#{orderBean.entity.routedTo!=null}" />
                        <hftl:formField label="#{messages['order.startDate']}" field="startDate" edit="false" rendered="#{orderBean.entity.startDate!=null}" />
                        <hftl:formField label="#{messages['order.expectedCompletionDate']}" field="expectedCompletionDate"
                            rendered="#{orderBean.entity.expectedCompletionDate!=null and orderBean.entity.completionDate==null}" />
                        <hftl:formField label="#{messages['order.completionDate']}" field="completionDate" rendered="#{orderBean.entity.completionDate!=null}" />
                    </p:fieldset>
                </p:tab>
                <p:tab title="#{messages['order.tab.orderItems']}" id="tabItems">

                    <p:dataTable id="orderItems" var="entity" value="#{orderBean.entity.orderItems}" paginator="false" rows="10" lazy="false" styleClass="custom-grid"
                        rowIndexVar="rowIndex" resizableColumns="true" sortBy="#{entity.itemId}" sortField="itemId">

                        <hftl:column label="#{messages['order.itemId']}" field="itemId" />
                        <hftl:column label="#{messages['order.action']}" field="action" isMessage="true" messagePrefix="OrderItemActionEnum" />
                        <hftl:column label="#{messages['order.userAccount']}" field="userAccount.descriptionOrCode" />
                        <hftl:column label="#{messages['order.productOfferings']}" field="productOfferings" isList="true" valueLabelField="descriptionOrCode" />
                        <p:column headerText="#{messages['commons.actions']}">
                            <p:commandButton icon="ui-icon-document" update=":orderForm:tabView:orderItemDetails">
                                <f:setPropertyActionListener value="#{entity}" target="#{orderBean.selectedOrderItem}" />
                            </p:commandButton>
                            <p:commandButton icon="ui-icon-trash" update="orderItems :orderForm:tabView:orderItemDetails"
                                rendered="#{orderBean.entity.status==OrderStatusEnum.IN_CREATION}">
                                <p:collector value="#{entity}" removeFrom="#{orderBean.entity.orderItems}" />
                                <p:confirm header="#{messages['commons.confirmationHeader']}" message="#{messages['commons.confirmDelete']}" icon="ui-icon-alert" />
                            </p:commandButton>
                        </p:column>
                        <f:facet name="footer">
                            <p:commandButton value="#{messages['commons.addNew']}" action="#{orderBean.newOrderItem()}" update=":orderForm:tabView:orderItemDetails"
                                rendered="#{orderBean.entity.status==OrderStatusEnum.IN_CREATION}" process="@this" />
                        </f:facet>
                    </p:dataTable>


                    <h:panelGroup id="orderItemDetails">
                        <p:separator rendered="#{orderBean.selectedOrderItem!=null}" />

                        <hftl:decorateFormPanel edit="#{orderBean.entity.status==OrderStatusEnum.IN_CREATION}" label="#{messages['order.orderItemHeader']}"
                            rendered="#{orderBean.selectedOrderItem!=null}">

                            <ui:define name="fields">
                                <hftl:formField entity="#{orderBean.selectedOrderItem}" label="#{messages['order.itemId']}" field="itemId" />
                                <hftl:formField entity="#{orderBean.selectedOrderItem}" label="#{messages['order.action']}" field="action" />
                                <hftl:formField entity="#{orderBean.selectedOrderItem}" label="#{messages['order.userAccount']}" field="userAccount"
                                    valueLabelField="descriptionOrCode" />


                                <h:panelGroup rendered="#{orderBean.entity.status == OrderStatusEnum.IN_CREATION}">
                                    <hftl:formField entity="#{orderBean.selectedOrderItem}" label="#{messages['order.offering']}" field="productOffering[0]" />


                                </h:panelGroup>
                                <h:panelGroup rendered="#{orderBean.entity.status != OrderStatusEnum.IN_CREATION}">

                                    <h:panelGroup rendered="#{orderBean.selectedOrderItem.action==OrderItemActionEnum.ADD}">

                                        <hftl:decorateFormField label="#{messages['order.offers']}" componentWidth="50">

                                            <p:tree value="#{orderBean.offersTree}" var="node" selectionMode="single" nodeVar="treeNode" style="width: 100%">
                                                <p:treeNode type="ServiceList">
                                                    <h:outputText value="#{messages['order.serviceList']}" />
                                                </p:treeNode>
                                                <p:treeNode type="ProductList">
                                                    <h:outputText value="#{messages['order.productList']}" />
                                                </p:treeNode>
                                                <p:treeNode type="OfferTemplate">
                                                    <h:outputText value="#{node.codeAndDescription}" />
                                                </p:treeNode>
                                                <p:treeNode type="ServiceTemplate">
                                                    <h:outputText value="#{node.codeAndDescription}" />
                                                </p:treeNode>
                                                <p:treeNode type="ProductTemplate">
                                                    <h:outputText value="#{node.codeAndDescription}" />
                                                </p:treeNode>
                                            </p:tree>
                                        </hftl:decorateFormField>
                                        <p:fieldset legend="#{messages['order.entitiesCreated']}" styleClass="clearLeft"
                                            rendered="#{orderBean.selectedOrderItem.productInstances!=null || orderBean.selectedOrderItem.subscription!=null}">
                                            <hftl:formField id="subscriptionAdd" entity="#{orderBean.selectedOrderItem}" label="#{messages['order.subscription']}"
                                                field="subscription" valueLabelField="descriptionOrCode" rendered="#{orderBean.selectedOrderItem.subscription!=null}" />
                                            <hftl:formField id="productsAdd" entity="#{orderBean.selectedOrderItem}" label="#{messages['order.products']}" field="productInstances"
                                                valueLabelField="descriptionOrCode"
                                                rendered="#{orderBean.selectedOrderItem.productInstances!=null and ! orderBean.selectedOrderItem.productInstances.isEmpty()}"
                                                listType="commaSeparated" componentWidth="50" />
                                        </p:fieldset>
                                    </h:panelGroup>


                                    <h:panelGroup
                                        rendered="#{orderBean.selectedOrderItem.action==OrderItemActionEnum.MODIFY || orderBean.selectedOrderItem.action==OrderItemActionEnum.DELETE}">

                                        <hftl:formField id="subscriptionModify" entity="#{orderBean.selectedOrderItem}" label="#{messages['order.subscription']}"
                                            field="subscription" valueLabelField="descriptionOrCode" rendered="#{orderBean.selectedOrderItem.subscription!=null}" />
                                        <hftl:formField id="productsModify" entity="#{orderBean.selectedOrderItem}" label="#{messages['order.products']}" field="productInstances"
                                            valueLabelField="descriptionOrCode"
                                            rendered="#{orderBean.selectedOrderItem.productInstances!=null and ! orderBean.selectedOrderItem.productInstances.isEmpty()}"
                                            listType="commaSeparated" componentWidth="50" />
                                    </h:panelGroup>
                                </h:panelGroup>
                            </ui:define>

                            <ui:define name="buttons">
                            </ui:define>
                        </hftl:decorateFormPanel>
                    </h:panelGroup>
                </p:tab>
            </p:tabView>

            <ui:param name="buttons" value="true" />
            <ui:define name="buttons">
                <p:commandButton value="Send to process" action="#{orderBean.sendToProcess()}" update="@form" rendered="#{orderBean.entity.status==OrderStatusEnum.IN_CREATION}" />
            </ui:define>

        </hftl:formPanel>
    </ui:define>
</ui:composition>
