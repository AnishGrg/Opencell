<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:s="http://jboss.org/seam/faces" xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html" xmlns:hftl="http://hftl.org" xmlns:hf="http://java.sun.com/jsf/composite/tags" xmlns:of="http://omnifaces.org/functions"
    xmlns:c="http://java.sun.com/jstl/core" xmlns:p="http://primefaces.org/ui" template="/layout/template.xhtml" xmlns:o="http://omnifaces.org/ui">

    <ui:define name="navigation">
        <ui:include src="/layout/navigation.xhtml" />
    </ui:define>

    <ui:define name="body">
        <hftl:entityPopup id="searchCustomEntity" header="#{messages['customEntity.popup.header']}" backingBean="#{customEntityTemplateListBean}"
            searchField1Label="#{messages['businessEntity.code']}" searchField1="code" column1Label="#{messages['businessEntity.code']}" column1="code"
            column2Label="#{messages['businessEntity.description']}" column2="description" selection="#{meveoModuleBean.customEntity}" updateField="moduleFormId:moduleItems">
        </hftl:entityPopup>
        <hftl:entityPopup id="searchCustomField" width="750" header="#{messages['customField.popup.header']}" backingBean="#{customFieldTemplateListBean}"
            searchField1Label="#{messages['businessEntity.code']}" searchField1="code" searchField2Label="#{messages['meveoModuleItem.appliesTo']}" searchField2="appliesTo"
            selection="#{meveoModuleBean.customField}" column1Label="#{messages['businessEntity.code']}" column1="code" column2Label="#{messages['businessEntity.description']}"
            column2="description" column3Label="#{messages['meveoModuleItem.appliesTo']}" column3="appliesTo" updateField="moduleFormId:moduleItems" column3Converter="customField">
        </hftl:entityPopup>
        <hftl:entityPopup id="searchFilter" header="#{messages['filter.popup.header']}" backingBean="#{filterListBean}" searchField1Label="#{messages['businessEntity.code']}"
            searchField1="code" column1Label="#{messages['businessEntity.code']}" column1="code" column2Label="#{messages['businessEntity.description']}" column2="description"
            selection="#{meveoModuleBean.filter}" updateField="moduleFormId:moduleItems">
        </hftl:entityPopup>
        <hftl:entityPopup id="searchScript" header="#{messages['scriptInstance.popup.header']}" backingBean="#{scriptInstanceListBean}"
            searchField1Label="#{messages['businessEntity.code']}" searchField1="code" column1Label="#{messages['businessEntity.code']}" column1="code"
            column2Label="#{messages['businessEntity.description']}" column2="description" selection="#{meveoModuleBean.script}" updateField="moduleFormId:moduleItems">
        </hftl:entityPopup>
        <hftl:entityPopup id="searchJob" header="#{messages['jobInstance.popup.header']}" backingBean="#{jobInstanceListBean}"
            searchField1Label="#{messages['businessEntity.code']}" searchField1="code" column1Label="#{messages['businessEntity.code']}" column1="code"
            column2Label="#{messages['businessEntity.description']}" column2="description" selection="#{meveoModuleBean.job}" updateField="moduleFormId:moduleItems">
        </hftl:entityPopup>
        <hftl:entityPopup id="searchNotification" header="#{messages['notification.popup.header']}" backingBean="#{genericNotificationListBean}"
            searchField1Label="#{messages['businessEntity.code']}" searchField1="code" column1Label="#{messages['businessEntity.code']}" column1="code"
            column2Label="#{messages['businessEntity.description']}" column2="description" selection="#{meveoModuleBean.notification}" updateField="moduleFormId:moduleItems">
        </hftl:entityPopup>
        <hftl:entityPopup id="searchSubModules" header="#{messages['meveoModule.popup.header']}" backingBean="#{meveoModuleListBean}" dataModel="#{meveoModuleBean.getSubModules()}"
            searchField1Label="#{messages['businessEntity.code']}" searchField1="code" column1Label="#{messages['businessEntity.code']}" column1="code"
            column2Label="#{messages['businessEntity.description']}" column2="description" selection="#{meveoModuleBean.meveoModule}" updateField="moduleFormId:moduleItems">
        </hftl:entityPopup>
        <hftl:entityPopup id="searchMeasurableQuantities" header="#{messages['measurableQuantity.popup.header']}" backingBean="#{measurableQuantityListBean}"
            searchField1Label="#{messages['businessEntity.code']}" searchField1="code" column1Label="#{messages['businessEntity.code']}" column1="code"
            column2Label="#{messages['businessEntity.description']}" column2="description" selection="#{meveoModuleBean.measurableQuantity}" updateField="moduleFormId:moduleItems">
        </hftl:entityPopup>
        <hftl:entityPopup id="searchCharts" header="#{messages['chart.popup.header']}" backingBean="#{chartListBean}" searchField1Label="#{messages['businessEntity.code']}"
            searchField1="code" column1Label="#{messages['businessEntity.code']}" column1="code" column2Label="#{messages['businessEntity.description']}" column2="description"
            selection="#{meveoModuleBean.chart}" updateField="moduleFormId:moduleItems">
        </hftl:entityPopup>

        <p:panel>
            <h:form id="crumbmenuForm">
                <p:breadCrumb homeDisplay="text" id="crumbmenu">
                    <p:menuitem value="#{messages['menu.admin']}" disabled="true" />
                    <p:menuitem outcome="meveoModules" value="#{messages['menu.meveoModules']}" />
                </p:breadCrumb>
            </h:form>
        </p:panel>
        <hftl:formPanel formId="moduleFormId" ajaxSubmit="true" buttons="true" label="#{messages['meveoModule.title']}" showEnableDisableButton="true"
            backingBean="#{meveoModuleBean}">
            <hftl:formField label="#{messages['businessEntity.code']}" field="code" maxlength="35" required="true" validateUnique="true" />
            <hftl:formField label="#{messages['businessEntity.description']}" field="description" required="true" id="description" maxlength="100" />
            <hftl:formField label="#{messages['meveoModule.license']}" required="true" field="license" id="license" isMessage="true" newLine="true" />
            <hftl:decorateFormField label="#{messages['meveoModule.logo']}" rendered="#{!meveoModuleBean.entity.transient}">
                <h:panelGrid columns="2" id="logo">
                    <c:set var="pictureDestUrlList"
                        value="http://${request.serverName}:${request.serverPort}${request.contextPath}/picture/${meveoModuleBean.entity.provider.code}/module/${meveoModuleBean.entity.logoPicture}" />
                    <p:graphicImage url="${pictureDestUrlList}" rendered="#{not empty meveoModuleBean.entity.logoPicture}" cache="false">
                        <f:attribute name="height" value="30"></f:attribute>
                        <f:attribute name="width" value="30"></f:attribute>
                    </p:graphicImage>
                    <p:commandButton value="#{messages['commons.upload']}" partialSubmit="true" process="@this" oncomplete="PF('uploadPictureDialog').show()"
                        rendered="#{!meveoModuleBean.entity.transient}"></p:commandButton>
                </h:panelGrid>
            </hftl:decorateFormField>
            <hftl:formField label="#{messages['enableEntity.disabled']}" doNotShowOnNew="true" allowEdit="false" field="disabled" isMessage="true" />
            <hftl:decorateFormField label="#{messages['meveoModule.items']}" componentWidth="100" displayOneLine="false" newLine="true">
                <p:treeTable id="moduleItems" lazy="false" value="#{meveoModuleBean.root}" var="e" reflow="false" resizableColumns="true" rowIndexVar="rowIndex">
                    <p:column headerText="#{messages['businessEntity.code']}">
                        <h:outputText value="#{e.root?messages[e.code]:e.code}" styleClass="field-value" />
                    </p:column>
                    <p:column headerText="#{messages['businessEntity.description']}">
                        <h:outputText value="#{e.description}" styleClass="field-value" />
                    </p:column>
                    <p:column headerText="#{messages['meveoModuleItem.appliesTo']}">
                        <h:outputText value="#{e.appliesTo}" styleClass="field-value" converter="customFieldConverter" />
                    </p:column>
                    <p:column headerText="#{messages['commons.actions']}">
                        <p:commandButton icon="ui-icon-minus" partialSubmit="true" process="@this" update="moduleItems" rendered="#{!e.root}"
                            action="#{meveoModuleBean.removeTreeNode(e)}" />
                    </p:column>
                    <f:facet name="footer" layout="block">
                        <p:commandButton value="#{messages['meveoModuleItem.addCE']}" partialSubmit="true" process="@this" oncomplete="PF('dlg_searchCustomEntity').show()" />
                        <p:commandButton value="#{messages['meveoModuleItem.addCF']}" partialSubmit="true" process="@this" oncomplete="PF('dlg_searchCustomField').show()" />
                        <p:commandButton value="#{messages['meveoModuleItem.addFilter']}" partialSubmit="true" process="@this" oncomplete="PF('dlg_searchFilter').show()" />
                        <p:commandButton value="#{messages['meveoModuleItem.addJob']}" partialSubmit="true" process="@this" oncomplete="PF('dlg_searchJob').show()" />
                        <p:commandButton value="#{messages['meveoModuleItem.addScript']}" partialSubmit="true" process="@this" oncomplete="PF('dlg_searchScript').show()" />
                        <p:commandButton value="#{messages['meveoModuleItem.addNotification']}" partialSubmit="true" process="@this"
                            oncomplete="PF('dlg_searchNotification').show()" />
                        <p:commandButton value="#{messages['meveoModuleItem.addSubModule']}" partialSubmit="true" process="@this" oncomplete="PF('dlg_searchSubModules').show()" />
                        <p:commandButton value="#{messages['meveoModuleItem.addMeasurableQuantity']}" partialSubmit="true" process="@this"
                            oncomplete="PF('dlg_searchMeasurableQuantities').show()" />
                        <p:commandButton value="#{messages['meveoModuleItem.addChart']}" partialSubmit="true" process="@this" oncomplete="PF('dlg_searchCharts').show()" />
                    </f:facet>
                </p:treeTable>
            </hftl:decorateFormField>
            <ui:param name="buttons" value="true" />
            <ui:define name="buttons">
                <p:commandButton id="publishModuleButton" update=":#{p:component('meveoModuleDialog')}" value="#{messages['meveoModule.publishModule']}"
                    rendered="#{not meveoModuleBean.entity.transient}" oncomplete="PF('meveoModuleDialog').show()">
                    <f:setPropertyActionListener value="#{null}" target="#{meveoModuleBean.meveoInstance}" />
                </p:commandButton>
            </ui:define>
        </hftl:formPanel>
        <p:dialog id="meveoModuleDialog" styleClass="confirm-dialog" header="#{messages['meveoModule.publishModule']}" widgetVar="meveoModuleDialog" width="700" modal="true">
            <hftl:decorateFormPanel formId="module" rendered="#{not meveoModuleBean.entity.transient}">
                <ui:define name="fields">
                    <hftl:decorateFormField fieldId="meveoInstance" label="#{messages['meveoModule.meveoInstance']}">
                        <p:selectOneMenu value="#{meveoModuleBean.meveoInstance}" id="meveoInstance" required="true">
                            <f:selectItem />
                            <f:selectItems value="#{meveoInstanceListBean.listAll()}" var="listVal" itemLabel="#{listVal.code}" itemValue="#{listVal}" />
                            <s:objectConverter />
                            <p:ajax event="valueChange" update="@form" />
                        </p:selectOneMenu>
                    </hftl:decorateFormField>
                </ui:define>
                <ui:define name="buttons">
                    <p:commandButton id="confirmOk" value="#{messages['commons.yes']}" oncomplete="if (args &amp;&amp; !args.validationFailed) PF('meveoModuleDialog').hide()"
                        action="#{meveoModuleBean.publishModule}" update=":module:messages :#{p:component('moduleFormId')}">
                    </p:commandButton>
                    <p:commandButton id="confirmKo" value="#{messages['commons.no']}" onclick="PF('meveoModuleDialog').hide()" type="button" />
                </ui:define>
            </hftl:decorateFormPanel>
        </p:dialog>
        <p:dialog id="uploadPictureDialog" styleClass="confirm-dialog" header="#{messages['meveoModule.uploadPicture.header']}" widgetVar="uploadPictureDialog" width="700"
            modal="true">
            <h:form id="uploadPictureForm" enctype="multipart/form-data">
                <p:messages autoUpdate="true" />
                <div class="clearLeft">
                    <p:fileUpload fileUploadListener="#{meveoModuleBean.handleFileUpload}" update="uploadPictureForm" multiple="false" mode="advanced" dragDropSupport="true"
                        process="@this" allowTypes="/(\.|\/)(gif|jpe?g|png)$/" auto="true" />
                </div>
                <h:panelGrid columns="2" id="picture" columnClasses="panelGrid-column50,panelGrid-column50" styleClass="panelGrid-column100">
                    <c:set var="pictureSourceUrl"
                        value="http://${request.serverName}:${request.serverPort}${request.contextPath}/picture/${meveoModuleBean.entity.provider.code}/module/tmp/${meveoModuleBean.tmpPicture}" />
                    <c:set var="pictureDestUrl2"
                        value="http://${request.serverName}:${request.serverPort}${request.contextPath}/picture/${meveoModuleBean.entity.provider.code}/module/${meveoModuleBean.entity.logoPicture}" />
                    <p:scrollPanel mode="native" style="width:400px;height:300px">
                        <p:imageCropper id="pic" value="#{meveoModuleBean.croppedImage}" image="${pictureSourceUrl}" minSize="30,30" maxSize="100,100" initialCoords="0,0,30,30"
                            rendered="#{not empty meveoModuleBean.tmpPicture}" />
                    </p:scrollPanel>
                    <p:graphicImage url="${pictureDestUrl2}" cache="false" rendered="#{not empty meveoModuleBean.entity.logoPicture}" />
                </h:panelGrid>
                <div class="clearLeft">
                    <p:commandButton id="cropButton" value="#{messages['meveoModule.crop']}" action="#{meveoModuleBean.cropLogo}" update="uploadPictureForm moduleFormId:logo"
                        icon="ui-icon-scissors" />
                    <p:commandButton id="closeButton" value="#{messages['commons.close']}" onclick="PF('uploadPictureDialog').hide()" type="button" />
                </div>
            </h:form>
        </p:dialog>
    </ui:define>

</ui:composition>
