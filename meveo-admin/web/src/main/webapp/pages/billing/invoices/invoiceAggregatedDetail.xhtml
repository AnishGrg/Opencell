<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:c="http://java.sun.com/jstl/core"
	xmlns:s="http://jboss.org/seam/faces"
	xmlns:h="http://java.sun.com/jsf/html" xmlns:hftl="http://hftl.org"
	xmlns:p="http://primefaces.org/ui" template="/layout/template.xhtml">

	<ui:define name="metadata">
		<f:metadata>
			<f:event type="preRenderView"
				listener="#{aggregatedDetailInvoiceBean.preRenderView}" />
		</f:metadata>
	</ui:define>

	<ui:define name="navigation">
		<ui:include src="/layout/navigation.xhtml" />
	</ui:define>

	<ui:define name="body">

		<c:if test="#{aggregatedDetailInvoiceBean.edit}">
			<hftl:entityPopup id="billingAccountPopup"
				header="#{messages['billingAccount']}"
				updateField=":tabView:formId:billingAccountSelectedId :tabView:formId:billingAccountSelectedId_text"
				selection="#{aggregatedDetailInvoiceBean.entity.billingAccount}"
				backingBean="#{billingAccountBean}"
				searchField1Label="#{messages['billingAccount.code']}"
				searchField1="code"
				column1Label="#{messages['billingAccount.code']}" column1="code"
				column2Label="#{messages['BusinessEntity.description']}"
				column2="description">
			</hftl:entityPopup>

			<hftl:entityPopup id="invoicePopup" header="#{messages['invoice']}"
				updateField=":tabView:formId:linkedInvoices :tabView:formId:importLinkedInvoices"
				selection="#{aggregatedDetailInvoiceBean.invoiceToAdd}"
				backingBean="#{aggregatedDetailInvoiceBean}"
				searchField1Label="#{messages['invoice.invoiceNumber']}"
				searchField1="invoiceNumber"
				column1Label="#{messages['invoice.invoiceNumber']}"
				column1="invoiceNumber"
				column2Label="#{messages['invoice.amountWithTax']}"
				column2="amountWithTax">
			</hftl:entityPopup>
		</c:if>

		<p:panel>
			<h:form id="crumbmenuForm">
				<p:breadCrumb homeDisplay="text" id="crumbmenu">
					<p:menuitem value="#{messages['menu.invoicing']}" disabled="true" />
				</p:breadCrumb>
			</h:form>
		</p:panel>

		<p:panel header="#{messages['invoice.aggregated']}">

			<p:growl id="growl" globalOnly="true"></p:growl>

			<p:tabView id="tabView"
				activeIndex="#{aggregatedDetailInvoiceBean.activeTab}">
				<p:tab title="#{messages['menu.invoice']}">
					<hftl:formPanel ajaxSubmit="true"
						submitPartialProcess=":tabView:formId"
						backingBean="#{aggregatedDetailInvoiceBean}"
						showEnableDisableButton="true">

						<p:panel style="width: 50%; float: left;">
							<hftl:formField field="invoiceType" required="true"
								style="width:300px;" label="#{messages['invoice.invoiceType']}"
								listenerUpdate="linkedInvoices"
								valueLabelField="descriptionOrCode"
								listBean="#{invoiceTypeBean}"></hftl:formField>
							<hftl:formField id="billingAccountSelectedId"
								label="#{messages['billingAccount']}" field="billingAccount"
								valueLabelField="code" popup="true"
								popupId="billingAccountPopup" required="true"
								showPopupOnlyOnNew="true" />
							<hftl:decorateFormField fieldId="dueDate" style="width:10px;"
								label="#{messages['invoice.dueDate']}">
								<p:calendar event="change" id="dueDate"
									value="#{aggregatedDetailInvoiceBean.entity.dueDate}"
									required="true"
									pattern="#{paramBean.getProperty('meveo.dateFormat', 'YYYY-mm-dd')}">
									<p:ajax event="dateSelect"
										listener="#{aggregatedDetailInvoiceBean.handleDateSelect}"></p:ajax>
								</p:calendar>
							</hftl:decorateFormField>
						</p:panel>

						<p:panel style="width: 50%; float: right;">
							<p:outputPanel id="linkedInvoices">
								<p:panel style="margin-top: 10px;"
									rendered="#{aggregatedDetailInvoiceBean.entity.invoiceType.code eq invoiceTypeBean.adjustmentCode}">
									<p:dataTable label="#{messages['invoice.linkedInvoices']}"
										noClose="false"
										value="#{aggregatedDetailInvoiceBean.entity.linkedInvoices}"
										var="entity">

										<f:facet name="header">#{messages['invoice.linkedInvoices']}</f:facet>
										<hftl:column label="#{messages['invoice.invoiceType']}"
											field="invoiceType.code" />
										<hftl:column label="#{messages['invoice.invoiceNumber']}"
											field="invoiceNumber" />
										<hftl:column label="#{messages['invoice.invoiceDate']}"
											field="invoiceDate" />
										<hftl:column label="#{messages['invoice.amountWithoutTax']}"
											field="amountWithoutTax" />
										<p:column width="20px;">
											<p:commandButton icon="ui-icon-trash"
												action="#{aggregatedDetailInvoiceBean.deleteLinkedInvoice}"
												update=":tabView:formId:linkedInvoices">
												<f:setPropertyActionListener value="#{entity}"
													target="#{aggregatedDetailInvoiceBean.selectedInvoice}" />
												<p:confirm
													header="#{messages['commons.confirmationHeader']}"
													message="#{messages['commons.confirmDelete']}"
													icon="ui-icon-alert" />
											</p:commandButton>
										</p:column>
									</p:dataTable>

									<h:panelGroup layout="block" styleClass="form-panel-actions">
										<p:commandButton value="#{messages['action.add']}"
											type="button" onclick="PF('dlg_invoicePopup').show();" />

										<p:commandButton value="#{messages['action.deleteAll']}"
											action="#{aggregatedDetailInvoiceBean.deleteAllLinkedInvoice}"
											update=":tabView:formId:linkedInvoices" />
									</h:panelGroup>
								</p:panel>
							</p:outputPanel>
						</p:panel>

						<div style="clear: both"></div>

						<!-- aggregated lines here -->
						<p:outputPanel id="aggregatedInvoicePanel">
							<p:dataTable style="margin-top: 10px;" var="entity"
								editable="true" editMode="cell"
								value="#{aggregatedDetailInvoiceBean.categoryInvoiceAggregates}">

								<f:facet name="header">#{messages['invoice.aggregates']}</f:facet>

								<p:ajax event="cellEdit" update="growl"
									listener="#{aggregatedDetailInvoiceBean.onCellEdit}">
								</p:ajax>

								<p:columnGroup type="header">
									<p:row>
										<p:column style="width: 200px;"
											headerText="#{messages['invoice.category']}" />
										<p:column headerText="#{messages['invoice.subCategory']}" />
									</p:row>
								</p:columnGroup>

								<p:column>
									<h:outputText value="#{entity.invoiceCategory.code}" />
									<p:cellEditor>
										<f:facet name="output">
											<h:outputText value="#{entity.invoiceCategory.description}" />
										</f:facet>
										<f:facet name="input">
											<p:inputText value="#{entity.invoiceCategory.description}"></p:inputText>
										</f:facet>
									</p:cellEditor>
									<span style="width: 5px;"> </span>
									<p:commandButton icon="ui-icon-trash" immediate="true"
										action="#{aggregatedDetailInvoiceBean.deleteLinkedInvoiceCategory}"
										update=":tabView:formId:aggregatedInvoicePanel :tabView:formId:invoiceSummary">
										<f:setPropertyActionListener value="#{entity}"
											target="#{aggregatedDetailInvoiceBean.selectedCategoryInvoiceAgregate}" />
									</p:commandButton>
								</p:column>

								<p:column>
									<p:dataTable editable="true" editMode="cell" id="subCategories"
										var="subCat"
										value="#{aggregatedDetailInvoiceBean.getSubCategoryInvoiceAggregates(entity)}">

										<p:ajax event="cellEdit" update="growl" />

										<p:columnGroup type="header">
											<p:row>
												<p:column headerText="#{messages['BusinessEntity.code']}" />
												<p:column
													headerText="#{messages['BusinessEntity.description']}" />
												<p:column
													headerText="#{messages['invoice.amountWithoutTax']}" />
												<p:column headerText="#{messages['commons.actions']}" />
											</p:row>
										</p:columnGroup>

										<p:column>
											<h:outputText value="#{subCat.invoiceSubCategory.code}" />
										</p:column>
										<p:column>
											<p:cellEditor>
												<f:facet name="output">
													<h:outputText value="#{subCat.description}" />
												</f:facet>
												<f:facet name="input">
													<p:inputText id="description" value="#{subCat.description}" />
												</f:facet>
											</p:cellEditor>
										</p:column>
										<p:column>
											<p:cellEditor>
												<f:facet name="output">
													<h:outputText value="#{subCat.amountWithoutTax}" />
												</f:facet>
												<f:facet name="input">
													<p:inputText value="#{subCat.amountWithoutTax}"></p:inputText>
												</f:facet>
											</p:cellEditor>

										</p:column>
										<p:column>
											<p:commandButton icon="ui-icon-trash"
												process=":tabView:formId:aggregatedInvoicePanel"
												action="#{aggregatedDetailInvoiceBean.deleteLinkedInvoiceSubCategory}"
												update=":tabView:formId:aggregatedInvoicePanel :tabView:formId:invoiceSummary">
												<f:setPropertyActionListener value="#{subCat}"
													target="#{aggregatedDetailInvoiceBean.selectedSubCategoryInvoiceAgregate}" />
											</p:commandButton>
										</p:column>

									</p:dataTable>
								</p:column>

							</p:dataTable>
						</p:outputPanel>

						<p:outputPanel id="importLinkedInvoices">
							<p:commandButton immediate="true"
								rendered="#{aggregatedDetailInvoiceBean.entity.linkedInvoices.size() > 0}"
								value="#{messages['action.invoice.importFromLinkedInvoices']}"
								action="#{aggregatedDetailInvoiceBean.importFromLinkedInvoices}"
								process=":tabView:formId @this"
								update=":tabView:formId:aggregatedInvoicePanel :tabView:formId:invoiceSummary :tabView:formId:messages" />
						</p:outputPanel>

						<div style="clear: both"></div>

						<p:fieldset style="float: right; width: 60%; margin-top: 10px;">
							<p:panel id="addAggregatedLine">
								<p:row>
									<p:column>
										<hftl:decorateFormField fieldId="selectedInvoiceCatOrSubCat"
											label="#{messages['invoice.catOrSubCat']}">
											<p:selectOneMenu id="selectedInvoiceCatOrSubCat"
												value="#{aggregatedDetailInvoiceBean.selectedInvoiceSubCategory}"
												converter="omnifaces.SelectItemsConverter">
												<f:selectItem itemLabel="" noSelectionOption="true" />
												<f:selectItems
													value="#{aggregatedDetailInvoiceBean.invoiceCatSubCats}" />
											</p:selectOneMenu>
										</hftl:decorateFormField>
									</p:column>
									<p:column>
										<hftl:decorateFormField fieldId="description"
											label="#{messages['BusinessEntity.description']}">
											<p:inputText id="description"
												value="#{aggregatedDetailInvoiceBean.description}"></p:inputText>
										</hftl:decorateFormField>
									</p:column>
									<p:column>
										<hftl:decorateFormField fieldId="amountWithoutTax"
											label="#{messages['invoice.amountWithoutTax']}">
											<p:inputText id="amountWithoutTax"
												value="#{aggregatedDetailInvoiceBean.amountWithoutTax}"></p:inputText>
										</hftl:decorateFormField>
									</p:column>
									<p:column>
										<p:commandButton value="#{messages['action.invoice.addLine']}"
											process="addAggregatedLine"
											action="#{aggregatedDetailInvoiceBean.addAggregatedLine()}"
											update=":tabView:formId:messages :tabView:formId:addAggregatedLine :tabView:formId:aggregatedInvoicePanel :tabView:formId:invoiceSummary"
											style="margin-top: 20px;">
										</p:commandButton>
									</p:column>
								</p:row>
							</p:panel>
							<h:outputLabel
								value="#{messages['message.invoice.addAggregate.info']}"></h:outputLabel>
						</p:fieldset>

						<div style="clear: both"></div>

						<p:outputPanel id="invoiceSummary">
							<p:panelGrid
								style="float: right; width: 40%; margin-top: 10px;"
								rendered="#{aggregatedDetailInvoiceBean.tempCategoryInvoiceAggregates.size() > 0}">
								<f:facet name="header">
									<p:row>
										<p:column>#{messages['invoice.summary.totalAmountWithoutTax']}</p:column>
										<p:column>#{messages['invoice.summary.totalTaxAmount']}</p:column>
										<p:column>#{messages['invoice.summary.totalAmountWithTax']}</p:column>
										<p:column>#{messages['invoice.summary.netToPay']}</p:column>
									</p:row>
								</f:facet>
								<p:row>
									<p:column>#{aggregatedDetailInvoiceBean.computeTotalAmountWithoutTax}</p:column>
									<p:column>#{aggregatedDetailInvoiceBean.computeTotalAmountTax}</p:column>
									<p:column>#{aggregatedDetailInvoiceBean.computeTotalAmountWithTax}</p:column>
									<p:column>#{aggregatedDetailInvoiceBean.netToPay}</p:column>
								</p:row>
							</p:panelGrid>
						</p:outputPanel>

						<div style="clear: both"></div>

						<p:outputPanel
							style="float: right; width: 30%; text-align: right; margin-top: 10px;">
							<h:panelGrid columns="2" style="float: right;">
								<h:panelGrid columns="2">
									<h:outputText
										value="#{messages['invoice.includeAccountBalance']}" />
									<p:selectBooleanCheckbox
										value="#{aggregatedDetailInvoiceBean.includeBalance}" />
								</h:panelGrid>
								<p:commandButton
									value="#{messages['action.invoice.refreshTotal']}"
									action="#{aggregatedDetailInvoiceBean.refreshTotal}"
									update=":#{p:component('invoiceSummary')}"></p:commandButton>
							</h:panelGrid>
						</p:outputPanel>

					</hftl:formPanel>

				</p:tab>
			</p:tabView>

		</p:panel>

	</ui:define>

</ui:composition>