<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:h="http://java.sun.com/jsf/html" xmlns:f="http://java.sun.com/jsf/core"
    xmlns:cc="http://java.sun.com/jsf/composite" xmlns:p="http://primefaces.org/ui" xmlns:o="http://omnifaces.org/ui" xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:hftl="http://hftl.org" xmlns:hf="http://java.sun.com/jsf/composite/tags">

<!-- 
    A tag to show a new custom field period creation popup dialog
    Makes part of custom field management tag group 

    Attributes
        edit - should values be displayed, or edit controls be shown
        datePattern - date pattern for date entry/display
        cft - internal attribute, custom field template 
        cfi - internal attribute, custom field instance to which a new period should be added 
        baseWrapper -  baseWrapper field for edit mode in list storage
        cfiDialogWidget - internal attribute, "a new custom field instance" dialog widget name for storage: list,map
 -->


<cc:interface componentType="formField">
    <cc:attribute name="edit" default="#{cc.backingBeanFromParentOrCurrent.edit}" />
    <cc:attribute name="datePattern" value="#{paramBean.getProperty('meveo.dateFormat','dd/MM/yyyy')}" />
    <cc:attribute name="cft" default="#{cc.backingBeanFromParentOrCurrent.customFieldSelectedTemplate}" />
    <cc:attribute name="cfi" default="#{cc.attrs.cft.instance}" />
    <cc:attribute name="baseWrapper" default="#{cc.backingBeanFromParentOrCurrent.baseWrapper}"/>
    <cc:attribute name="cfiDialogWidget" default="dlg_newcfi_#{cc.entityClass.simpleName}" />
</cc:interface>

<cc:implementation>
	<o:importConstants type="org.meveo.model.crm.CustomFieldTypeEnum" />
	<o:importConstants
		type="org.meveo.model.crm.CustomFieldStorageTypeEnum" />
    <span id="#{cc.clientId}" style="white-space: nowrap"> <p:dialog id="cft_cfi_newcfi" widgetVar="#{cc.attrs.cfiDialogWidget}"
            header="#{messages['customFieldTemplate.newCfi']}" closeOnEscape="true" modal="true" appendTo="@(body)" rendered="#{cc.attrs.edit}" width="700">
            <h:form id="dlg_cft_cfi_newform">
            	<c:set var="storage" value="#{cc.attrs.cft.storageType eq 'LIST'?'list':'map'}"/>
            	<c:set var="field" value="#{cc.attrs.cft.fieldType eq 'DATE'?'date':(cc.attrs.cft.fieldType eq 'LONG'?'long':(cc.attrs.cft.fieldType eq 'DOUBLE'?'double':
            		((cc.attrs.cft.fieldType eq 'LIST' or cc.attrs.cft.fieldType eq 'STRING' or cc.attrs.cft.fieldType eq 'TEXT_AREA')?'string':
            		(cc.attrs.cft.fieldType eq 'ENTITY'?'entity':'null'))))}"/>
                <p:panel>
                    <h:panelGroup id="cfi_fields" layout="block" styleClass="form-panel">
                        <p:messages id="cfi_messages" />
                        <p:outputPanel styleClass="form-panel-fields">
                        	<!-- single -->
                            <hf:formDecorateField label="#{cc.attrs.cft.description} #{cc.attrs.cft.valueRequired?'*':''}" rendered="#{cc.attrs.cft.storageType eq 'SINGLE'}">
                                <hftl:customFieldValueField edit="true" cft="#{cc.attrs.cft}" field="#{cc.attrs.cft.instance}" />
                            </hf:formDecorateField>
                            <!-- edit for list -->
                            <hf:formDecorateField label="#{cc.attrs.cft.description} #{cc.attrs.cft.valueRequired?'*':''}" rendered="#{cc.attrs.cft.storageType eq 'LIST' and cc.attrs.baseWrapper!=null}">
                                <hftl:customFieldValueField edit="true" cft="#{cc.attrs.cft}" field="#{cc.attrs.baseWrapper}" />
                            </hf:formDecorateField>
                            <!-- new for list -->
                            <hf:formDecorateField label="#{cc.attrs.cft.description} #{cc.attrs.cft.valueRequired?'*':''}" rendered="#{cc.attrs.cft.storageType eq 'LIST' and cc.attrs.baseWrapper==null}">
                                <hftl:customFieldValueField edit="true" cft="#{cc.attrs.cft}" field="#{cc.attrs.cfi}" />
                            </hf:formDecorateField>
                            <!-- new for map -->
                            <hf:formDecorateField fieldId="#{cc.attrs.baseWrapper==null?'cft_cfi_label':'wrapper_label'}" label="#{messages['commons.label']}" rendered="#{cc.attrs.cft.storageType eq 'MAP'}">
                                <p:inputText id="cft_cfi_label" value="#{cc.attrs.cft.instance.label}"
									required="true" rendered="#{cc.attrs.baseWrapper==null}" disabled="#{!empty(cc.attrs.cft.instance.label)}"/>
								<p:inputText id="wrapper_label" value="#{cc.attrs.baseWrapper.label}" disabled="#{!empty(cc.attrs.baseWrapper.label)}"
									required="true" rendered="#{cc.attrs.baseWrapper!=null}"/>
                            </hf:formDecorateField>
                            <hf:formDecorateField label="#{cc.attrs.cft.description} #{cc.attrs.cft.valueRequired?'*':''}" rendered="#{cc.attrs.cft.storageType eq 'MAP'}" newLine="true" componentWidth="200px">
                            	<!-- string,list,textarea -->
                            	<p:dataTable id="newcfi_stringlist" resizableColumns="true" value="#{cc.attrs.cft.instance.stringList}" var="list" rendered="#{cc.attrs.cft.fieldType eq 'STRING' or cc.attrs.cft.fieldType eq 'LIST' or cc.attrs.cft.fieldType eq 'TEXT_AREA'}"
                            		editMode="cell" editable="true">
                            		<p:ajax event="cellEdit"/>
                            		<p:column sortBy="#{list.stringValue}" headerText="#{messages['commons.value']}">
                            			<p:cellEditor>
                            				<f:facet name="output"><hftl:customFieldValueField cft="#{cc.attrs.cft}" field="#{list}" edit="false"/></f:facet>
                            				<f:facet name="input"><hftl:customFieldValueField cft="#{cc.attrs.cft}" field="#{list}" edit="true"/></f:facet>
                            			</p:cellEditor>
                            		</p:column>
                            		<p:column headerText="#{messages['commons.actions']}" width="15%">
                        				<p:commandButton icon="ui-icon-minus" partialSubmit="true" process="@this" actionListener="#{cc.attrs.cft.instance.removeStringFromlist(list)}"
                        					update="newcfi_stringlist"/>
                    				</p:column>
                    				<f:facet name="footer">
                    					<p:commandButton value="#{messages['commons.addNew']}" icon="ui-icon-plus" partialSubmit="true" process="@this"
                    						update="newcfi_stringlist" actionListener="#{cc.attrs.cft.instance.addNewTolist(cc.attrs.cft)}"/>
                    				</f:facet>
                            	</p:dataTable>
                            	<!-- date -->
                            	<p:dataTable id="newcfi_datelist" resizableColumns="true" value="#{cc.attrs.cft.instance.dateList}" var="list" rendered="#{cc.attrs.cft.fieldType=='DATE'}">
                            		<p:column sortBy="#{list.dateValue}" headerText="#{messages['commons.value']}">
                            			<p:cellEditor>
                            				<f:facet name="output"><hftl:customFieldValueField cft="#{cc.attrs.cft}" field="#{list}" edit="false"/></f:facet>
                            				<f:facet name="input"><hftl:customFieldValueField cft="#{cc.attrs.cft}" field="#{list}" edit="true"/></f:facet>
                            			</p:cellEditor>
                            		</p:column>
                            		<p:column headerText="#{messages['commons.actions']}" width="15%">
                        				<p:commandButton icon="ui-icon-minus" partialSubmit="true" process="@this newcfi_datelist" actionListener="#{cc.attrs.cft.removeDateFromlist(list)}"
                        					update="newcfi_datelist" immediate="true"/>
                    				</p:column>
                    				<f:facet name="footer">
                    					<p:commandButton value="#{messages['commons.addNew']}" partialSubmit="true" process="@this"
                    						update="newcfi_datelist" actionListener="#{cc.attrs.cft.addNewTolist(cc.attrs.cft)}"/>
                    				</f:facet>
                            	</p:dataTable>
                            	<!-- long -->
                            	<p:dataTable id="newcfi_longlist" resizableColumns="true" value="#{cc.attrs.cft.instance.longList}" var="list" rendered="#{cc.attrs.cft.fieldType=='LONG'}"
                            		editMode="cell" editable="true">
                            		<p:ajax event="cellEdit"></p:ajax>
                            		<p:column sortBy="#{list.longValue}" headerText="#{messages['commons.value']}">
                            			<p:cellEditor>
                            				<f:facet name="output"><hftl:customFieldValueField cft="#{cc.attrs.cft}" field="#{list}" edit="false"/></f:facet>
                            				<f:facet name="input"><hftl:customFieldValueField cft="#{cc.attrs.cft}" field="#{list}" edit="true"/></f:facet>
                            			</p:cellEditor>
                            		</p:column>
                            		<p:column headerText="#{messages['commons.actions']}" width="15%">
                        				<p:commandButton icon="ui-icon-minus" partialSubmit="true" process="@this newcfi_longlist" actionListener="#{cc.attrs.cft.instance.removeLongFromlist(list)}"
                        					update="@this newcfi_longlist" immediate="true" ajax="true" />
                    				</p:column>
                    				<f:facet name="footer">
                    					<p:commandButton value="#{messages['commons.addNew']}" partialSubmit="true" process="@this" immediate="true"
                    						update="newcfi_longlist" actionListener="#{cc.attrs.cft.instance.addNewTolist(cc.attrs.cft)}"/>
                    				</f:facet>
                            	</p:dataTable>
                            	<!-- double -->
                            	<p:dataTable id="newcfi_doublelist" resizableColumns="true" value="#{cc.attrs.cft.instance.doubleList}" var="list" rendered="#{cc.attrs.cft.fieldType=='DOUBLE'}"
                            		editMode="cell" editable="true">
                            		<p:ajax event="cellEdit"/>
                            		<p:column sortBy="#{list.doubleValue}" headerText="#{messages['commons.value']}" sortable="#{list.doubleValue}">
                            			<p:cellEditor>
                            				<f:facet name="output"><hftl:customFieldValueField cft="#{cft}" field="#{list}" edit="false"/></f:facet>
                            				<f:facet name="input"><hftl:customFieldValueField cft="#{cft}" field="#{list}" edit="true"/></f:facet>
                            			</p:cellEditor>
                            		</p:column>
                            		<p:column headerText="#{messages['commons.actions']}" width="15%">
                        				<p:commandButton icon="ui-icon-minus" partialSubmit="true" process="@this newcfi_doublelist" actionListener="#{cc.attrs.cft.instance.removeDoubleFromlist(list)}"
                        					update="newcfi_doublelist"/>
                    				</p:column>
                    				<f:facet name="footer">
                    					<p:commandButton value="#{messages['commons.addNew']}" partialSubmit="true" process="@this newcfi_doublelist"
                    						update="newcfi_doublelist" actionListener="#{cc.attrs.cft.instance.addNewTolist(cc.attrs.cft)}"/>
                    				</f:facet>
                            	</p:dataTable>
                            	<!-- entity -->
                            	<p:dataTable id="newcfi_entitylist" resizableColumns="true" value="#{cc.attrs.cft.instance.entityList}" var="list" rendered="#{cc.attrs.cft.fieldType=='ENTITY'}">
                            		<p:column sortBy="#{list.businessEntity.code}" headerText="#{messages['commons.value']}">
                            			<hftl:customFieldValueField cft="#{cc.attrs.cft}" field="#{list}" edit="true"/>
                            		</p:column>
                            		<p:column headerText="#{messages['commons.actions']}" width="15%">
                        				<p:commandButton icon="ui-icon-minus" partialSubmit="true" process="@this newcfi_entitylist" actionListener="#{cc.attrs.cft.instance.removeEntityFromlist(list)}"
                        					update="newcfi_entitylist"/>
                    				</p:column>
                    				<f:facet name="footer">
                    					<p:commandButton value="#{messages['commons.addNew']}" partialSubmit="true" process="@this newcfi_entitylist"
                    						update="newcfi_entitylist" actionListener="#{cc.attrs.cft.instance.addNewTolist(cc.attrs.cft)}"/>
                    				</f:facet>
                            	</p:dataTable>
                            </hf:formDecorateField>
                        </p:outputPanel>
                        <h:panelGroup layout="block" styleClass="form-panel-actions">
                        	<!-- save new for list,map -->
                        	<p:commandButton id="save" rendered="#{(cc.attrs.baseWrapper==null and cc.attrs.cft.storageType eq CustomFieldStorageTypeEnum.LIST) or (cc.attrs.cft.storageType eq 'MAP' and empty(cc.attrs.cft.instance.label))}"
									actionListener="#{cc.attrs.cft.instance.saveTolist(cc.attrs.cft)}" ajax="true"
									partialSubmit="true" process="@form" value="#{messages['commons.add']}"	update="@form @([id$='customFields_#{field}#{storage}'])"
									oncomplete="if (args &amp;&amp; !args.validationFailed) PF('#{cc.attrs.cfiDialogWidget}').hide()" />
							<!-- edit for list,map -->
							<p:commandButton id="edit" rendered="#{(cc.attrs.baseWrapper!=null and cc.attrs.cft.storageType eq 'LIST') or (cc.attrs.cft.storageType eq 'MAP' and !empty(cc.attrs.cft.instance.label))}" ajax="true"
									partialSubmit="true" process="@form" value="#{messages['commons.save']}"
									update="@form @([id$='customFields_#{field}#{storage}'])"
									actionListener="#{cc.attrs.cft.instance.saveTolist(cc.attrs.cft)}"
									oncomplete="if (args &amp;&amp; !args.validationFailed) PF('#{cc.attrs.cfiDialogWidget}').hide()" />
						</h:panelGroup>
                    </h:panelGroup>
                </p:panel>
            </h:form>
        </p:dialog>
    </span>
</cc:implementation>
</html>