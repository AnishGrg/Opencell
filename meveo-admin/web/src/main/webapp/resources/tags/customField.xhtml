<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:h="http://java.sun.com/jsf/html" xmlns:f="http://java.sun.com/jsf/core"
    xmlns:cc="http://java.sun.com/jsf/composite" xmlns:p="http://primefaces.org/ui" xmlns:o="http://omnifaces.org/ui" xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:hftl="http://hftl.org" xmlns:hf="http://java.sun.com/jsf/composite/tags">


<!-- 
    A tag to display a single custom field
    Makes part of custom field management tag group 

    Attributes
        prefix - prefix for component to distinguish when used multiple times in save page
        entity - entity, custom fields are related to
        edit - edit mode. Inherited from formPanel otherwise
        datePatter - date pattern   
        messagesId - an ID of messages component for validation messages
        cft - custom field template

 -->

<cc:interface>
    <cc:attribute name="entity" required="true" />
    <cc:attribute name="cft" required="true" />
    <cc:attribute name="edit" required="true" />
    <cc:attribute name="datePattern" required="true" />
    <cc:attribute name="messagesId" required="true" />
    <cc:attribute name="prefix" required="true" />
    <cc:attribute name="disabled" default="#{!cc.attrs.entity.transient and !cc.attrs.cft.allowEdit}" />
    <cc:attribute name="fieldsValues" default="#{customFieldDataEntryBean.getFieldsValues(cc.attrs.entity.uuid)}" />
</cc:interface>

<cc:implementation>

    <o:importConstants type="org.meveo.model.crm.custom.CustomFieldStorageTypeEnum" />
    <o:importConstants type="org.meveo.model.crm.custom.CustomFieldMapKeyEnum" />
    <o:importFunctions type="org.meveo.model.crm.custom.CustomFieldValue" var="cfv" />
    <c:set var="dateTimePattern" value="#{paramBean.getProperty('meveo.dateTimeFormat','dd/MM/yyyy HH:mm')}" />
    <!--     <c:if test="${empty(datePattern)}"> -->
    <!--         <c:set var="datePattern" value="#{paramBean.getProperty('meveo.dateFormat','dd/MM/yyyy')}" /> -->
    <!--     </c:if> -->

    <c:if test="#{!cc.attrs.cft.versionable}">
        <c:if test="#{cc.attrs.cft.storageType eq CustomFieldStorageTypeEnum.SINGLE }">
            <hftl:decorateFormField label="#{cc.attrs.cft.description}#{cc.attrs.cft.valueRequired?' *':''}" componentWidth="25" displayOneLine="false">
                <hftl:customFieldValueField edit="#{cc.attrs.edit}" cft="#{cc.attrs.cft}" field="#{cc.attrs.fieldsValues.getFirstValue(cc.attrs.cft.code).cfValue}"
                    entity="#{cc.attrs.entity}" disabled="#{cc.attrs.disabled}" />
            </hftl:decorateFormField>
            <c:set var="inheritedValue" value="#{customFieldDataEntryBean.getInheritedCFValue(cc.attrs.entity, cc.attrs.cft.code)}" />
            <c:if test="#{inheritedValue !=null}">
                <hftl:decorateFormField fieldId="cfField_stringI" label="#{cc.attrs.cft.description} #{messages['customField.inheritedValue']}" componentWidth="50" displayOneLine="false">
                    <h:outputText id="cfField_stringI" value="#{cfv:getShortRepresentationOfValueObj(inheritedValue, cc.attrs.datePattern)}" styleClass="field-value" />
                </hftl:decorateFormField>
            </c:if>
        </c:if>

        <c:if
            test="#{(cc.attrs.cft.storageType eq CustomFieldStorageTypeEnum.MAP or cc.attrs.cft.storageType eq CustomFieldStorageTypeEnum.LIST or cc.attrs.cft.storageType eq CustomFieldStorageTypeEnum.MATRIX) }">
            <hftl:customFieldListTable edit="#{cc.attrs.edit}" cft="#{cc.attrs.cft}" entity="#{cc.attrs.entity}"
                field="#{cc.attrs.fieldsValues.getFirstValue(cc.attrs.cft.code).cfValue}" messagesId="#{cc.attrs.messagesId}" disabled="#{cc.attrs.disabled}" />

            <c:set var="inheritedValue" value="#{customFieldDataEntryBean.getInheritedCFValueAsCFValue(cc.attrs.entity, cc.attrs.cft, cc.attrs.cft.code)}" />
            <c:if test="#{inheritedValue !=null}">
                <hftl:customFieldListTable inherited="true" edit="false" cft="#{cc.attrs.cft}" entity="#{cc.attrs.entity}" field="#{inheritedValue}" messagesId="#{cc.attrs.messagesId}"
                    disabled="#{cc.attrs.disabled}" />
            </c:if>
        </c:if>


    </c:if>

    <c:if test="#{cc.attrs.cft.versionable}">
        <hftl:decorateFormField label="#{cc.attrs.cft.description}#{cc.attrs.cft.valueRequired?' *':''}" componentWidth="100" displayOneLine="false">
            <p:dataTable id="periodTable_omitFromSubmit" lazy="false" value="#{cc.attrs.fieldsValues.values[cc.attrs.cft.code]}" var="period"
                sortField="#{cc.attrs.cft.calendar!=null?period.periodStartDate:period.priority}"
                editable="#{cc.attrs.edit and cc.attrs.cft.storageType==CustomFieldStorageTypeEnum.SINGLE and !cc.attrs.disabled}" editMode="cell" resizableColumns="true"
                reflow="true">

                <p:ajax event="cellEdit" update="#{cc.attrs.messagesId}" partialSubmit="true" partialSubmitFilter=":not([name*='addNewFields'])" />

                <p:column headerText="#{messages['customFieldTemplate.priority']}" width="10%" sortBy="#{period.priority}" rendered="#{cc.attrs.cft.calendar==null}">
                    <h:outputText value="#{period.priority}"></h:outputText>
                </p:column>
                <p:column headerText="#{messages['customFieldTemplate.periodStartDate']}" width="13%" sortBy="#{period.periodStartDate}">
                    <h:outputText value="#{period.periodStartDate}">
                        <f:convertDateTime type="date" pattern="#{dateTimePattern}" />
                    </h:outputText>
                </p:column>
                <p:column headerText="#{messages['customFieldTemplate.periodEndDate']}" width="13%" sortBy="#{period.periodEndDate}">
                    <h:outputText value="#{period.periodEndDate}">
                        <f:convertDateTime type="date" pattern="#{dateTimePattern}" />
                    </h:outputText>
                </p:column>
                <p:column headerText="#{messages['customFieldTemplate.periodValue']}">
                    <p:cellEditor rendered="#{cc.attrs.cft.storageType == CustomFieldStorageTypeEnum.SINGLE}">
                        <f:facet name="output">
                            <hftl:customFieldValueField edit="false" cft="#{cc.attrs.cft}" field="#{period.cfValue}" entity="#{cc.attrs.entity}" />
                        </f:facet>
                        <f:facet name="input">
                            <hftl:customFieldValueField edit="true" cft="#{cc.attrs.cft}" field="#{period.cfValue}" entity="#{cc.attrs.entity}" />
                        </f:facet>
                    </p:cellEditor>
                    <h:outputText value="#{period.cfValue.getShortRepresentationOfValue(cc.attrs.cft, cc.attrs.datePattern)}"
                        rendered="#{cc.attrs.cft.storageType != CustomFieldStorageTypeEnum.SINGLE}" />
                </p:column>
                <p:column headerText="#{messages['commons.actions']}" width="15%">
                    <!-- update="periodFields"  -->
                    <p:commandButton icon="ui-icon-search" immediate="true" update=":#{p:component(cc.attrs.prefix.concat('periodFields'))}"
                        actionListener="#{cc.attrs.fieldsValues.clearNewValueDefaults(cc.attrs.cft)}" onsuccess="PF('#{cc.attrs.prefix}periodValuesDialogWidget').show()"
                        rendered="#{cc.attrs.cft.storageType != CustomFieldStorageTypeEnum.SINGLE}">
                        <f:setPropertyActionListener target="#{customFieldDataEntryBean.selectedFieldTemplate[cc.attrs.entity.uuid]}" value="#{cc.attrs.cft}" />
                        <f:setPropertyActionListener target="#{customFieldDataEntryBean.selectedValuePeriod[cc.attrs.entity.uuid]}" value="#{period}" />
                        <f:setPropertyActionListener target="#{customFieldDataEntryBean.selectedValuePeriodId[cc.attrs.entity.uuid]}" value=":#{component.parent.parent.clientId}" />
                        <p:resetInput target=":#{p:component(cc.attrs.prefix.concat('periodFields'))}" />
                    </p:commandButton>
                    <!-- <p:commandButton id="deletelink" action="#{cc.attrs.cft.instance.removeValuePeriod(period)}" partialSubmit="true" process="@this" icon="ui-icon-trash"
                                        update="periodTable_omitFromSubmit" rendered="#{cc.attrs.edit}" /> -->
                </p:column>
                <f:facet name="footer">
                    <p:messages globalOnly="false" redisplay="false" />

                    <hf:namingContainer id="addNewFields" rendered="#{cc.attrs.edit and !cc.attrs.disabled}">

                        <p:calendar id="period_date" showButtonPanel="true" pattern="#{dateTimePattern}"
                            value="#{cc.attrs.fieldsValues.newValues[cc.attrs.cft.code.concat('_periodStartDate')]}" required="true" styleClass="minWidthCalendar"
                            label="#{messages['customFieldTemplate.periodDate']}" placeholder="#{messages['customFieldTemplate.periodDate']}"
                            rendered="#{cc.attrs.cft.calendar!=null}">
                        </p:calendar>
                        <p:calendar id="period_start_date" showButtonPanel="true" pattern="#{dateTimePattern}"
                            value="#{cc.attrs.fieldsValues.newValues[cc.attrs.cft.code.concat('_periodStartDate')]}" styleClass="minWidthCalendar"
                            label="#{messages['customFieldTemplate.periodStartDate']}" placeholder="#{messages['customFieldTemplate.periodStartDate']}"
                            rendered="#{cc.attrs.cft.calendar==null}">
                        </p:calendar>

                        <p:calendar id="period_end_date" showButtonPanel="true" pattern="#{dateTimePattern}" styleClass="minWidthCalendar"
                            value="#{cc.attrs.fieldsValues.newValues[cc.attrs.cft.code.concat('_periodEndDate')]}" label="#{messages['customFieldTemplate.periodEndDate']}"
                            placeholder="#{messages['customFieldTemplate.periodEndDate']}" rendered="#{cc.attrs.cft.calendar==null}">
                        </p:calendar>

                        <c:if test="#{cc.attrs.cft.storageType == CustomFieldStorageTypeEnum.SINGLE}">
                            <hftl:customFieldValueMuteField edit="true" cft="#{cc.attrs.cft}" field="#{cc.attrs.fieldsValues.newValues[cc.attrs.cft.code.concat('_value')]}"
                                required="true" label="#{messages['commons.value']}" placeholder="#{messages['commons.value']}" />
                        </c:if>
                    </hf:namingContainer>

                    <p:commandButton value="#{messages['customFieldTemplate.addNewPeriod']}" partialSubmit="true" process="@this addNewFields" update="periodTable_omitFromSubmit"
                        action="#{customFieldDataEntryBean.addNewValuePeriod(cc.attrs.entity.uuid, cc.attrs.cft)}"
                        rendered="#{cc.attrs.edit and !cc.attrs.disabled and cc.attrs.cft.storageType == CustomFieldStorageTypeEnum.SINGLE}">
                        <p:resetInput target="addNewFields" />
                    </p:commandButton>

                    <p:commandButton value="#{messages['customFieldTemplate.addNewPeriod']}" partialSubmit="true" process="@this addNewFields"
                        update="periodTable_omitFromSubmit :#{p:component(cc.attrs.prefix.concat('periodFields'))}"
                        oncomplete="if (args &amp;&amp; !args.validationFailed) PF('#{cc.attrs.prefix}periodValuesDialogWidget').show()"
                        action="#{customFieldDataEntryBean.addNewValuePeriod(cc.attrs.entity.uuid, cc.attrs.cft)}"
                        rendered="#{cc.attrs.edit and !cc.attrs.disabled and cc.attrs.cft.storageType != CustomFieldStorageTypeEnum.SINGLE}">
                        <p:resetInput target="addNewFields" />
                        <p:resetInput target=":#{p:component(cc.attrs.prefix.concat('periodFields'))}" />
                        <f:setPropertyActionListener target="#{customFieldDataEntryBean.selectedValuePeriodId[cc.attrs.entity.uuid]}"
                            value=":#{cc.clientId}:periodTable_omitFromSubmit" />
                    </p:commandButton>


                </f:facet>
            </p:dataTable>
        </hftl:decorateFormField>
    </c:if>


</cc:implementation>
</html>